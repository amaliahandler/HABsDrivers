---
title: "CyanoHABs National Drivers and Predictions"
format: docx
authors: Amalia Handler, Michael Dumelle, and Melanie Reynolds
editor: visual
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
# Load model development data
devtools::load_all()

# Load packages
library(spmodel)
library(dplyr)
library(tidyr)
library(ggplot2)
library(sf)
library(tigris)
library(knitr)
library(here)
library(corrplot)
library(flextable)

# Do not include code chunks in document
knitr::opts_chunk$set(echo = FALSE, message = FALSE)

# Data prep
habs <- habs |>
  mutate(n_farm_inputs = N_Fert_Farm + N_CBNF + N_livestock_Waste,
         n_dev_inputs = N_Human_Waste + N_Fert_Urban,
         p_farm_inputs = P_f_fertilizer + P_livestock_Waste,
         p_dev_inputs = P_human_waste_kg + P_nf_fertilizer) |>
  mutate(MICX_DET = factor(ifelse(is.finite(MICX), 1, 0))) |>
  mutate(MAXDEPTH = ifelse(MAXDEPTH == 999, NA, MAXDEPTH),
         n_farm_inputs = ifelse(n_farm_inputs > 600, NA, n_farm_inputs),
         p_farm_inputs = ifelse(p_farm_inputs > 100, NA, p_farm_inputs),
         n_dev_inputs = ifelse(n_dev_inputs > 300, NA, n_dev_inputs),
         p_dev_inputs = ifelse(p_dev_inputs > 100, NA, p_dev_inputs),
         TEMPERATURE = ifelse(TEMPERATURE > 50, NA, TEMPERATURE))

# Load model objects
cyano_lake <- readRDS(paste0(here(), "/inst/model_objects/model_cyano_withlakedata.rds"))
micx_lake  <- readRDS(paste0(here(), "/inst/model_objects/model_micx_withlakedata.rds"))

cyano_nolake <- readRDS(paste0(here(), "/inst/model_objects/model_cyano_nolakedata.rds"))
micx_nolake  <- readRDS(paste0(here(), "/inst/model_objects/model_micx_nolakedata.rds"))

```

## Results

### Map of NLA sample locations

Note: Should this map be restricted to only the observations used in the model development?

```{r nla map compilation, message = FALSE}
# CONUS with state outlines
conus <- tigris::states(cb = TRUE, progress_bar = FALSE) |>
  filter(!STUSPS %in% c('HI', 'PR', 'AK', 'MP', 'GU', 'AS', 'VI')) |>
  st_transform(crs = 5072)

nla_map <- ggplot() + 
  geom_sf(data = conus, fill = "#e2e2e2", color = "white", size = 0.5) +
  geom_sf(data = habs, shape = 24, fill = "grey39", size = 1, stroke = .2) +
  theme_void() +
  theme(legend.position = "bottom")

```

```{r nla map}
#| label: nla-map
#| fig-width: 6
#| fig-height: 4
#| fig-cap: "Lakes sampled in the 2007, 2012, and 2017 National Lakes Assessment. Darker points represent lakes sampled multiple times."
nla_map

```

### Table of model variables

```{r construct variable summary table}
# Each variable that was considered in the modeling process
# Note that some of these values were excluded from the model development process because of suspected unreasonable outliers. Will need to update this once I determine where in the pipeline to trim these data.

summerizer <- function(var){
  colnum <- match(var[1], colnames(habs))
  dat    <- pull(habs, colnum)
  tibble(Variable = var[2],
         Units = var[3],
         Min = min(dat, na.rm = TRUE),
         Med = median(dat, na.rm = TRUE),
         Mean = mean(dat, na.rm = TRUE),
         Max = max(dat, na.rm = TRUE),
         Scale = var[4],
         Source = var[5]
         )
}

vec_list <- list(
  c("B_G_DENS", "Cyanobacteria", "cells/mL", "Lake", "NLA"),
  c("MICX", "Microcystin", "ug/L", "Lake", "NLA"),
  c("PTL", "Total Phosphorus", "ug/L", "Lake", "NLA"),
  c("NTL", "Total Nitrogen", "mg N/L", "Lake", "NLA"),
  c("NITRATE_N", "Nitrate", "mg N/L", "Lake", "NLA"),
  c("AMMONIA_N", "Ammonium", "mg N/L", "Lake", "NLA"),
  c("DOC", "Dissolved Organic Carbon", "mg/L", "Lake", "NLA"),
  c("PH", "pH", "Std. Units", "Lake", "NLA"),
  c("TURB", "Tubidty", "NTU", "Lake", "NLA"),
  c("EVAP_INFL", "Evaporation:Inflow", "unitless", "Lake", "NLA"),
  c("MAXDEPTH", "Maximum Lake Depth", "meters", "Lake", "NLA"),
  c("lakemorpho_fetch", "Lake Fetch", "meters", "Lake", "Lakemorpho"),
  c("N_Fert_Farm", "Farm Fertilizer N", "kg/ha/yr", "Watershed", "National Nutrient Inventory"),
  c("N_livestock_Waste", "Livestock Waste N", "kg/ha/yr", "Watershed", "National Nutrient Inventory"),
  c("N_CBNF", "Cultivated Crop Biological Nitrogen Fixation", "kg/ha/yr", "Watershed", "National Nutrient Inventory"),
  c("P_f_fertilizer", "Farm Fertilizer P", "kg/ha/yr", "Watershed", "National Nutrient Inventory"),
  c("P_livestock_Waste", "Livestock Waste P", "kg/ha/yr", "Watershed", "National Nutrient Inventory"),
  c("N_Human_Waste", "Human Waste N", "kg/ha/yr", "Watershed", "National Nutrient Inventory"),
  c("N_Fert_Urban", "Non-Farm Fertilizer N", "kg/ha/yr", "Watershed", "National Nutrient Inventory"),
  c("P_human_waste_kg", "Human Waste P", "kg/ha/yr", "Watershed", "National Nutrient Inventory"),
  c("P_nf_fertilizer", "Non-Farm Fertilizer P", "kg/ha/yr", "Watershed", "National Nutrient Inventory"),
  c("n_farm_inputs", "Total Farm N Inputs", "kg/ha/yr", "Watershed", "National Nutrient Inventory"),
   c("p_farm_inputs", "Total Farm P Inputs", "kg/ha/yr", "Watershed", "National Nutrient Inventory"),
   c("n_dev_inputs", "Total Developed N Inputs", "kg/ha/yr", "Watershed", "National Nutrient Inventory"),
   c("p_dev_inputs", "Total Developed P Inputs", "kg/ha/yr", "Watershed", "National Nutrient Inventory"),
  c("fst_ws", "Forested Land Cover", "percent", "Watershed", "NLCD 2011"),
  c("BFIWs", "Baseflow Index", "unitless", "Watershed", "LakeCat"),
  c("precip_mean_month", "Month Mean Precipitation", "millimeters", "Watershed", "LakeCat"),
  c("temp_mean_month", "Month Mean Temperature", "degC", "Watershed", "LakeCat"),
  c("Precip8110Ws", "Mean Annual Precipitation", "millimeters", "Watershed", "LakeCat"),
  c("Tmean8110Ws", "Mean Annual Temperature", "millimeters", "Watershed", "LakeCat")
)

summary_covariate_table <- do.call(rbind, lapply(vec_list, summerizer))

```

```{r varable summary table}
#| label: tbl-var-summary
#| 
#| tbl-cap: Summary statistics for response variable and covariates in the model.

kable(summary_covariate_table,
      digits = 2,
      format.args = list(scientific = FALSE))

```

```{r setup correlation plot}
#| label: cor-plot
#| fig-width: 6
#| fig-height: 6
#| fig-cap: "Pairwise spearman's rank correlation matrix of all covariates considered for the models."

# Trim to just the variables explored in the models
cor_dat <- habs |>
  st_drop_geometry() |>
  select(TEMPERATURE, MAXDEPTH, AMMONIA_N, DOC:NITRATE_N, PH, D_EXCESS, EVAP_INFL, fst_ws, wet_ws, precip_mean_month, temp_mean_month, lakemorpho_fetch, BFIWs, KffactWs:Precip_Minus_EVTWs, Precip8110Ws, Tmean8110Ws, N_Total_Deposition, n_farm_inputs:p_dev_inputs) |>
  relocate(NTL, PTL, NITRATE_N, AMMONIA_N, DOC, PH, TEMPERATURE, TURB, D_EXCESS, EVAP_INFL, fst_ws, wet_ws, KffactWs, n_farm_inputs, p_farm_inputs, n_dev_inputs, p_dev_inputs, N_Total_Deposition, precip_mean_month, temp_mean_month, Precip8110Ws, Tmean8110Ws, Precip_Minus_EVTWs, RunoffWs, BFIWs, MAXDEPTH, lakemorpho_fetch)

var_names <- c("Total N", 
               "Total P",   
               "Nitrate", 
               "Ammonia", 
               "DOC", 
               "pH", 
               "Water Temp",
               "Turbidity",
               "Evaporation",
               "Evaporation/Inflow",
               "Forest Cover", 
               "Wetland Cover",
               "Soil Erodability",
               "Farm N",
               "Farm P",
               "Developed N", 
               "Developed P",
               "Deposition N", 
               "Monthly Precip",
               "Monthly Temp",
               "Annual Precip", 
               "Annual Air Temp",
               "Annual Precip-ET",
               "Runoff", 
               "Baseflow Index",
               "Lake Depth",
               "Lake Fetch")

cormat_pred <- cor(cor_dat, use = "pairwise.complete.obs", method = "spearman")

colnames(cormat_pred) <- var_names
rownames(cormat_pred) <- var_names

# Lower triangle plot
corrplot(cormat_pred, method = "ellipse", type = "lower", tl.col = "black", tl.srt = 45, tl.cex = 0.75)

```

```{r extract model fixed effects}
#| label: tbl-fixed_effects
#| tbl-cap: Model fixed effect coefficient sign (negative or positive) and p-value (* <0.05, ** <0.01, **** < 0.001) for cyanobacteria and microcystin models both where in-lake data was present or absent.

# Function to extract the fixed effects from each model
fixed_effect_retriever <- function(model_obj, resp_var, lake_data){
  summary(model_obj)$coefficients$fixed |>
    mutate(fixed_effect = rownames(summary(model_obj)$coefficients$fixed)) |>
    mutate(response_var = resp_var,
           lake_data = lake_data) |>
    tibble() |>
    rename(estimate = estimates) |>
    relocate(response_var, lake_data, fixed_effect, .before = estimate)
}

# Extract the effects
fixed_df <- rbind(
  fixed_effect_retriever(micx_lake, resp_var = "micx", lake_data = "present"),
  fixed_effect_retriever(micx_nolake, resp_var = "micx", lake_data = "absent"),
  fixed_effect_retriever(cyano_lake, resp_var = "cyano", lake_data = "present"),
  fixed_effect_retriever(cyano_nolake, resp_var = "cyano", lake_data = "absent")
)

# Table that includes both response variables and models with and without lake data. Covariates are converted to positive or negative signs with asterisks denoting the associated p-values.
pal <- RColorBrewer::brewer.pal(9, "RdBu")

est_and_sign <- fixed_df |>
  filter(!fixed_effect == "(Intercept)") |>
  mutate(est_sign = ifelse(estimate > 0, "+", "−"),
         sig = case_when(p >= 0.05 ~ "ns",
                         p < 0.05 & p >= 0.01 ~ "*",
                         p < 0.01 & p >= 0.001 ~ "**",
                         p < 0.001 ~ "***"),
         est_sig = paste0(est_sign, " (", sig, ")"),
         fixed_effect = factor(fixed_effect, 
                               levels = c("NTL",
                                          "NITRATE_N",
                                          "AMMONIA_N",
                                          "DOC",
                                          "TURB",
                                          "PH",
                                          "EVAP_INFL",
                                          "MAXDEPTH",
                                          "lakemorpho_fetch",
                                          "n_farm_inputs",
                                          "p_farm_inputs",
                                          "n_dev_inputs",
                                          "p_dev_inputs",
                                          "fst_ws",
                                          "BFIWs",
                                          "Precip8110Ws",
                                          "Tmean8110Ws",
                                          "AG_ECO3PLNLOW",
                                          "AG_ECO3EHIGH",
                                          "NTL:AG_ECO3PLNLOW",
                                          "NTL:AG_ECO3EHIGH"))
         ) |>
  select(response_var:fixed_effect, est_sig) |>
  pivot_wider(names_from = response_var:lake_data,
              values_from = est_sig,
              values_fill = "") |>
  arrange(fixed_effect) |>
  relocate(fixed_effect, cyano_present, micx_present, cyano_absent, micx_absent) # |>
  # mutate(fixed_effect = c("Total N", 
  #                      "Nitrate", 
  #                      "Ammonium", 
  #                      "DOC", 
  #                      "Turbidity",
  #                      "pH",
  #                      "Evaporation/Inflow",
  #                      "Lake Depth",
  #                      "Lake Fetch",
  #                      "Farm N Inputs",
  #                      "Farm P Inputs",
  #                      "Developed N Inputs", 
  #                      "Developed P Inputs",
  #                      "Forest Cover", 
  #                      "Baseflow Index",
  #                      "Annual Precip", 
  #                      "Annual Air Temp",
  #                      "Ecoregion PLNLOW",
  #                      "Ecoregion EHIGH",
  #                      "Total N * PLNLOW",
  #                      "Total N * EHIGH")
  #           ) |>
  # rename(Covariates = fixed_effect)

colorer <- function(i){
  hex <- case_when(i == "+ (***)" ~ pal[1],
                   i == "+ (**)" ~  pal[2],
                   i == "+ (*)" ~   pal[3],
                   i == "+ (ns)" ~  pal[4],
                   i == "" ~        pal[5],
                   i == "− (ns)" ~  pal[6],
                   i == "− (*)" ~   pal[7],
                   i == "− (**)" ~  pal[8],
                   i == "− (***)" ~ pal[9])
}

est_and_sign |>
  flextable() |>
  bg(bg = colorer,
     j = ~ . -Corvariates,
     part = "body")


as.data.frame(matrix(runif(5*5), ncol = 5)) %>% 
  flextable() %>% 
  colformat_double() %>% 
  autofit() %>% 
  align(align = "center", part = "all") %>% 
  bg(bg = "black", part = "header") %>% 
  color(color = "white", part = "all") %>% 
  bg(bg = scales::col_numeric(palette = "viridis", domain = c(0, 1)))

```

```{r fitted values maps}
#| label: fitted-maps
#| fig-width: 6
#| fig-height: 6
#| fig-cap: "Fitted values for the cyanobacteria and microcystin models without in-lake data."

cyano_nolake_loocv <- loocv(cyano_nolake, cv_predict = TRUE)

cyano_nolake_aug <- augment(cyano_nolake) |>
  mutate(preds = cyano_nolake_loocv$cv_predict) |>
  arrange(preds)

fit_cyano <- ggplot() + 
  geom_sf(data = conus, fill = "#e2e2e2", color = "white", lwd = 1) +
  geom_sf(data = cyano_nolake_aug, 
          aes(fill = preds), pch = 21, size = 2) +
  scale_fill_gradientn(colors = RColorBrewer::brewer.pal(9, 'YlOrRd'),
                       name = "Cyanobacteria\nLog10(Count + \n1000)") +
  theme_void()

micx_sp_nolake_aug <- augment(micx_nolake)

fit_micx <- ggplot() + 
  geom_sf(data = conus, fill = "#e2e2e2", color = "white", lwd = 1) +
  geom_sf(data = micx_sp_nolake_aug, aes(fill = .fitted), pch = 21, size = 2) +
  scale_fill_gradientn(colors = RColorBrewer::brewer.pal(9, 'YlOrRd'),
                       name = "Microcystin\nFitted \nProbability") +
  theme_void()

ggpubr::ggarrange(plotlist = list(fit_cyano, fit_micx),
                  nrow = 2)

```

```{r model fit comparison}
#| label: tbl-mod-fit
#| tbl-cap: Comparison of model fit for model where in-lake data is present or absent and based on spatial of independent error models.

comp_cyan <- readRDS(paste0(here(), "/inst/model_objects/spatial_compare_cyano.rds")) |>
  rename(fit = cor2)

comp_micx <- readRDS(paste0(here(), "/inst/model_objects/spatial_compare_micx.rds")) |>
  rename(fit = auc)

fit_comp <- 
  rbind(comp_cyan, comp_micx) |>
  select(resp_var, spatial_mod, lake_data, fit) |>
  pivot_wider(names_from = lake_data,
              values_from = fit) |>
  rename(Model = resp_var,
         Error_Structure = spatial_mod)

knitr::kable(fit_comp, digits = 2)

```

```{r spatial covariance maps}
#| label: spcov-maps
#| fig-width: 6
#| fig-height: 6
#| fig-cap: "Spatial covariance for the cyanobacteria and microcystin models without in-lake data."

cyano_aug <- augment(cyano_nolake)
cyano_aug$.spde <- fitted(cyano_nolake, type = "spcov")$de

spcov_cyano <- ggplot() + 
  geom_sf(data = conus, fill = "#e2e2e2", color = "white", lwd = 1) +
  geom_sf(data = arrange(cyano_aug, .spde), 
          aes(fill = .spde), pch = 21, size = 2) +
  colorspace::scale_fill_continuous_divergingx(palette = 'RdBu', mid = 0, rev = TRUE, name = "Spatial \nCovariance") +
  ggtitle("Cyanobacteria") +
  theme_void()

micx_aug <- micx_nolake |>
  augment() |>
  mutate(.spde = fitted(micx_nolake, type = "spcov")$de, .after = .std.resid)

spcov_micx <- ggplot() + 
  geom_sf(data = conus, fill = "#e2e2e2", color = "white", lwd = 1) +
  geom_sf(data = arrange(micx_aug, .spde), 
          aes(fill = .spde), pch = 21, size = 2) +
  colorspace::scale_fill_continuous_divergingx(palette = 'RdBu', mid = 0, rev = TRUE, name = "Spatial \nCovariance") +
  ggtitle("Microcystin") +
  theme_void()

ggpubr::ggarrange(plotlist = list(spcov_cyano, spcov_micx),
                  nrow = 2)
```

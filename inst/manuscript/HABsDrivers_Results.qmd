---
title: "CyanoHABs National Drivers and Predictions"
format: docx
authors: Amalia Handler, Michael Dumelle, and Melanie Reynolds
editor: visual
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
# Load model development data
devtools::load_all()

# Load packages
library(here)
library(spmodel)
library(dplyr)
library(tidyr)
library(ggplot2)
library(sf)
library(tigris)
library(knitr)
library(here)
library(corrplot)
library(flextable)
library(officer)
library(officedown)
library(stringr)

# Do not include code chunks in document
knitr::opts_chunk$set(echo = FALSE, message = FALSE)

# Data prep
habs <- habs |>
  mutate(n_farm_inputs = N_Fert_Farm + N_CBNF + N_livestock_Waste,
         n_dev_inputs = N_Human_Waste + N_Fert_Urban,
         p_farm_inputs = P_f_fertilizer + P_livestock_Waste,
         p_dev_inputs = P_human_waste_kg + P_nf_fertilizer) |>
  mutate(MICX_DET = factor(ifelse(is.finite(MICX), 1, 0))) |>
  mutate(MAXDEPTH = ifelse(MAXDEPTH == 999, NA, MAXDEPTH),
         n_farm_inputs = ifelse(n_farm_inputs > 600, NA, n_farm_inputs),
         p_farm_inputs = ifelse(p_farm_inputs > 100, NA, p_farm_inputs),
         n_dev_inputs = ifelse(n_dev_inputs > 300, NA, n_dev_inputs),
         p_dev_inputs = ifelse(p_dev_inputs > 100, NA, p_dev_inputs),
         TEMPERATURE = ifelse(TEMPERATURE > 50, NA, TEMPERATURE))

# Load model objects
cyano_lake <- readRDS(paste0(here(), "/inst/model_objects/model_cyano_withlakedata.rds"))
micx_lake  <- readRDS(paste0(here(), "/inst/model_objects/model_micx_withlakedata.rds"))

cyano_nolake <- readRDS(paste0(here(), "/inst/model_objects/model_cyano_nolakedata.rds"))
micx_nolake  <- readRDS(paste0(here(), "/inst/model_objects/model_micx_nolakedata.rds"))

# p-value results for models with lake conditions
pval <- function(x){ifelse(x < 0.001, "p<0.001", paste0("p=",round(x, 3)))}

doc_cyano <- pval(summary(cyano_lake)$coefficients$fixed$p[5])
doc_micx  <- pval(summary(micx_lake)$coefficients$fixed$p[4])
int_cyano_plnlow <- pval(summary(cyano_lake)$coefficients$fixed$p[15])


```

## Results

### Drivers of CyanoHABs

Both the cyanobacteria and microcystin models were driven by a similar set of covariates with some differences in the relative importance of individual covariates within each model.

#### Models with In-Lake Conditions

Among the models that included the in-lake conditions, total N was positively correlated with by cyanobacteria abundance and the probability of microcystin. Nitrate and DOC were negatively correlated with cyanobacteria abundance and probability of microcystin, but while DOC had a high degree of confidence in importance for cyanobacteria (`r doc_cyano`), the microcystin model DOC term was not significant (`r doc_micx`). Ammonium and tubidity were both negatively correlated with cyanobacteria, but absent in the final microcystin model. Finally, the evaporation to inflow ratio was positively correlated with both cyanobacteria abundance and probability of microcystin detection, indicating that both cyanobacteria and microcystin are mor common in lakes with water that has experience more evaporation relative to the inflowing water.

For lake morphology, deeper lakes had lower cyanobacteria and probability of microcystin detection and lakes with longer fetch had higher cyanobacteria and probability of microcystin. 

Few of the watershed nutrient input terms were included in the final models; however, farm P inputs were positively correlated with the probability of microcystin detection.

Among geographic setting variables, lake watersheds with lower mean annual precipitation and higher mean annual air temperature were correlated with higher cyanobacteria abundance and probability of microcystin. Both the PLNLOW and EHIGH ecoregions had high cyanobacteria and probability of microcystin compared to the WMTNS ecoregion.

Finally, there was an interaction between the lake total N concentration and the ecoregion where higher total N concentration in the EHIGH ecoregion is correlated with significantly higher cyanobacteria abundance relative to the WMTNS. There was also a small negative interaction between the total N concentration and the EHIGH, but not significant (`r int_cyano_plnlow`). The final microcystin model did not contain any interactions.

### Map of NLA sample locations

Note: Should this map be restricted to only the observations used in the model development?

```{r nla map compilation, message = FALSE}
# CONUS with state outlines
conus <- tigris::states(cb = TRUE, progress_bar = FALSE) |>
  filter(!STUSPS %in% c('HI', 'PR', 'AK', 'MP', 'GU', 'AS', 'VI')) |>
  st_transform(crs = 5072)

nla_map <- ggplot() + 
  geom_sf(data = conus, fill = "#e2e2e2", color = "white", size = 0.5) +
  geom_sf(data = habs, shape = 24, fill = "grey39", size = 1, stroke = .2) +
  theme_void() +
  theme(legend.position = "bottom")

```

```{r nla map}
#| label: nla-map
#| fig-width: 6
#| fig-height: 4
#| fig-cap: "Lakes sampled in the 2007, 2012, and 2017 National Lakes Assessment. Darker points represent lakes sampled multiple times."
nla_map

```

```{r setup correlation plot}
#| label: cor-plot
#| fig-width: 6
#| fig-height: 6
#| fig-cap: "Pairwise spearman's rank correlation matrix of all covariates considered for the models."

# Trim to just the variables explored in the models
cor_dat <- habs |>
  st_drop_geometry() |>
  select(TEMPERATURE, MAXDEPTH, AMMONIA_N, DOC:NITRATE_N, PH, D_EXCESS, EVAP_INFL, fst_ws, wet_ws, precip_mean_month, temp_mean_month, lakemorpho_fetch, BFIWs, KffactWs:Precip_Minus_EVTWs, Precip8110Ws, Tmean8110Ws, N_Total_Deposition, n_farm_inputs:p_dev_inputs) |>
  relocate(NTL, PTL, NITRATE_N, AMMONIA_N, DOC, PH, TEMPERATURE, TURB, D_EXCESS, EVAP_INFL, fst_ws, wet_ws, KffactWs, n_farm_inputs, p_farm_inputs, n_dev_inputs, p_dev_inputs, N_Total_Deposition, precip_mean_month, temp_mean_month, Precip8110Ws, Tmean8110Ws, Precip_Minus_EVTWs, RunoffWs, BFIWs, MAXDEPTH, lakemorpho_fetch)

var_names <- c("Total N", 
               "Total P",   
               "Nitrate", 
               "Ammonia", 
               "DOC", 
               "pH", 
               "Water Temp",
               "Turbidity",
               "Evaporation",
               "Evaporation/Inflow",
               "Forest Cover", 
               "Wetland Cover",
               "Soil Erodability",
               "Farm N Inputs",
               "Farm P Inputs",
               "Developed N Inputs", 
               "Developed P Inputs",
               "Deposition N", 
               "Monthly Precip",
               "Monthly Air Temp",
               "Annual Precip", 
               "Annual Air Temp",
               "Annual Precip-ET",
               "Runoff", 
               "Baseflow Index",
               "Lake Depth",
               "Lake Fetch")

cormat_pred <- cor(cor_dat, use = "pairwise.complete.obs", method = "spearman")

colnames(cormat_pred) <- var_names
rownames(cormat_pred) <- var_names

# Lower triangle plot
corrplot(cormat_pred, method = "ellipse", type = "lower", tl.col = "black", tl.srt = 45, tl.cex = 0.75)

```

```{r extract model fixed effects}
# Function to extract the fixed effects from each model
fixed_effect_retriever <- function(model_obj, resp_var, lake_data){
  summary(model_obj)$coefficients$fixed |>
    mutate(fixed_effect = rownames(summary(model_obj)$coefficients$fixed)) |>
    mutate(response_var = resp_var,
           lake_data = lake_data) |>
    tibble() |>
    rename(estimate = estimates) |>
    relocate(response_var, lake_data, fixed_effect, .before = estimate)
}

# Extract the effects
fixed_df <- rbind(
  fixed_effect_retriever(micx_lake, resp_var = "micx", lake_data = "present"),
  fixed_effect_retriever(micx_nolake, resp_var = "micx", lake_data = "absent"),
  fixed_effect_retriever(cyano_lake, resp_var = "cyano", lake_data = "present"),
  fixed_effect_retriever(cyano_nolake, resp_var = "cyano", lake_data = "absent")
)

# Table that includes both response variables and models with and without lake data. Covariates are converted to positive or negative signs with asterisks denoting the associated p-values.
# pal <- RColorBrewer::brewer.pal(9, "RdBu")
# pal <- c("#B2182B", "#db1d35", "#e54155", "#eb6a7a", "#F7F7F7", "#72abe4", "#4c94dd", "#287dd2", "#2166AC")
pal <- c("#eb6a7a", "#f08f9b", "#f5b4bc", "#fadade", "#F7F7F7", "#dceaf8", "#b8d5f1", "#95c0eb", "#72abe4")

est_and_sign <- fixed_df |>
  filter(!fixed_effect == "(Intercept)") |>
  mutate(est_sign = ifelse(estimate > 0, "+", "−"),
         sig = case_when(p >= 0.05 ~ "ns",
                         p < 0.05 & p >= 0.01 ~ "*",
                         p < 0.01 & p >= 0.001 ~ "**",
                         p < 0.001 ~ "***"),
         est_sig = paste0(est_sign, " (", sig, ")"),
         fixed_effect = factor(fixed_effect, 
                               levels = c("NTL",
                                          "NITRATE_N",
                                          "AMMONIA_N",
                                          "DOC",
                                          "TURB",
                                          "PH",
                                          "EVAP_INFL",
                                          "MAXDEPTH",
                                          "lakemorpho_fetch",
                                          "n_farm_inputs",
                                          "p_farm_inputs",
                                          "n_dev_inputs",
                                          "p_dev_inputs",
                                          "fst_ws",
                                          "BFIWs",
                                          "Precip8110Ws",
                                          "Tmean8110Ws",
                                          "AG_ECO3PLNLOW",
                                          "AG_ECO3EHIGH",
                                          "NTL:AG_ECO3PLNLOW",
                                          "NTL:AG_ECO3EHIGH"))
         ) |>
  select(response_var:fixed_effect, est_sig) |>
  pivot_wider(names_from = response_var:lake_data,
              values_from = est_sig,
              values_fill = "") |>
  arrange(fixed_effect) |>
  relocate(fixed_effect, cyano_present, micx_present, cyano_absent, micx_absent) |>
  mutate(fixed_effect = c("Total N",
                       "Nitrate",
                       "Ammonium",
                       "DOC",
                       "Turbidity",
                       "pH",
                       "Evaporation/Inflow",
                       "Lake Depth",
                       "Lake Fetch",
                       "Farm N Inputs",
                       "Farm P Inputs",
                       "Developed N Inputs",
                       "Developed P Inputs",
                       "Forest Cover",
                       "Baseflow Index",
                       "Annual Precip",
                       "Annual Air Temp",
                       "Ecoregion PLNLOW",
                       "Ecoregion EHIGH",
                       "Total N * PLNLOW",
                       "Total N * EHIGH"),
         Type = c(rep("In-Lake Conditions", 7),
                  rep("Lake Geometry", 2),
                  rep("Nutrient Inputs", 5),
                  rep("Geographic Setting", 5),
                  rep("Interactions", 2)), .before = fixed_effect
            ) |>
  rename(Covariates = fixed_effect)

colorer <- function(i){
  hex <- case_when(i == "+ (***)" ~ pal[1],
                   i == "+ (**)" ~  pal[2],
                   i == "+ (*)" ~   pal[3],
                   i == "+ (ns)" ~  pal[4],
                   i == "" ~        pal[5],
                   i == "− (ns)" ~  pal[6],
                   i == "− (*)" ~   pal[7],
                   i == "− (**)" ~  pal[8],
                   i == "− (***)" ~ pal[9])
}

est_header <- data.frame(
  col_keys = colnames(est_and_sign),
  line2 = c(rep("Model", 2), rep("In-Lake Conditions", 4)),
  line3 = c(rep("Model", 2), c(rep("Present", 2), rep("Absent", 2))),
  line4 = c("Type", "Corvariates", rep(c("Cyanobacteria", "Microcystin"), 2))
)

covar_tbl <- est_and_sign |>
  flextable() |>
  set_header_df(mapping = est_header, key = "col_keys" ) |>
  merge_v(part = "header", j = c(1:2)) |> 
  merge_v(part = "body", j = 1) |> 
  merge_h(part = "header", i = c(1:2)) |> 
  theme_booktabs(bold_header = TRUE) |>
  bg(bg = colorer,
     j = 3:6, # All columns in the body except for the first one
     part = "body") |>
  bg(j = c(5:6), i = c(1:7), bg = "#606060") |> # Covariates that weren't available to the models
  theme_box() |>
  align(align = "center", part = "header") |>
  fontsize(size = 10, part = "body") |>
  fontsize(size = 10, part = "header")

```

```{r covariate table}
#| label: tbl-fixed_effects
#| tbl-cap: Model fixed effect coefficient sign (negative or positive) and p-value (* <0.05, ** <0.01, **** < 0.001) for cyanobacteria and microcystin models both where in-lake data was present or absent. Grey cells are in-lake conditions covariates that were excluded from model development 
covar_tbl
```

```{r standarized residual maps}
#| label: std-resid-maps
#| fig-width: 6
#| fig-height: 6
#| fig-cap: "Standardized residuals for the cyanobacteria and microcystin models without in-lake conditions."

cyano_nolake_aug <- augment(cyano_nolake) |>
  mutate(resp = "Cyanobacteria") |>
  select(resp, .std.resid)
micx_nolake_aug  <- augment(micx_nolake) |>
  mutate(resp = "Microcystin") |>
  select(resp, .std.resid) |>
  st_transform(st_crs(cyano_nolake_aug))

std_resid_comb <- rbind(cyano_nolake_aug, micx_nolake_aug) |>
  mutate(rank = case_when(.std.resid > 4 ~ 4,
                          .std.resid > 3 & .std.resid < 4 ~ 3,
                          .std.resid < -2 ~ 2,
                          TRUE ~ 1)) |>
  arrange(rank)

ggplot() + 
  geom_sf(data = conus, fill = "#e2e2e2", color = "white", lwd = 1) +
  geom_sf(data = std_resid_comb, 
          aes(fill = .std.resid), pch = 21, size = 1.5) +
  facet_wrap(~ resp, ncol = 1, nrow = 2) +
  colorspace::scale_fill_continuous_divergingx(palette = "BrBG", 
                                               mid = 0, 
                                               name = "Standardized\nResidual") +
    theme_void()

```

```{r model fit comparison}
#| label: tbl-mod-fit
#| tbl-cap: Comparison of model fit for model where in-lake data is present or absent and based on spatial of independent error models.

comp_cyan <- readRDS(paste0(here(), "/inst/model_objects/spatial_compare_cyano.rds")) |>
  rename(fit = cor2)

comp_micx <- readRDS(paste0(here(), "/inst/model_objects/spatial_compare_micx.rds")) |>
  rename(fit = auc)

options(digits = 2)
rbind(comp_cyan, comp_micx) |>
  select(-MSPE) |>
  mutate(resp_var = case_when(resp_var == "cyano" ~ "Cyanobacteria",
                              resp_var == "micx" ~ "Microcystin"),
         lake_data = case_when(lake_data == "present" ~ "Present",
                               lake_data == "absent" ~ "Absent"),
         spatial_mod = case_when(spatial_mod == "spatial" ~ "Spatial",
                                 spatial_mod == "non-spatial" ~ "Independent")) |>
  flextable() |>
  set_header_labels(values = list(
    resp_var = "Response Variable",
    lake_data = "In-Lake Conditions",
    spatial_mod = "Error Structure",
    bias = "Bias",
    RMSPE = "RMSPE",
    fit = "Fit")) |>
  merge_v(part = "body", j = c(1:2)) |> 
  footnote(i = 1, j = 6,
           value = as_paragraph("Fit is R^2 for cyanobacteria models and AUC for microcystin models."), ref_symbols = "a", part = "header") |>
  theme_booktabs(bold_header = TRUE) |>
  fontsize(size = 10, part = "body") |>
  fontsize(size = 10, part = "header") |>
  fontsize(size = 9, part = "footer") |>
  theme_box() |>
  align(align = "center", part = "header")

```

```{r spatial covariance maps}
#| label: spcov-maps
#| fig-width: 6
#| fig-height: 6
#| fig-cap: "Spatial covariance for the cyanobacteria and microcystin models without in-lake data."

cyano_aug <- augment(cyano_nolake) |>
  mutate(spde = fitted(cyano_nolake, type = "spcov")$de,
         resp = "Cyanobacteria") |>
  select(resp, spde)

micx_aug <- augment(micx_nolake) |>
  mutate(spde = fitted(micx_nolake, type = "spcov")$de,
         resp = "Microcystin") |>
  select(resp, spde) |>
  st_transform(st_crs(cyano_aug))
  
spde <- rbind(cyano_aug, micx_aug)

ggplot() + 
  geom_sf(data = conus, fill = "#e2e2e2", color = "white", lwd = 1) +
  geom_sf(data = spde, 
          aes(fill = spde), pch = 21, size = 1.5) +
  facet_wrap(~ resp, ncol = 1, nrow = 2) +
  colorspace::scale_fill_continuous_divergingx(palette = "BrBG", 
                                               mid = 0, 
                                               name = "Spatial\nAutocorrelation") +
    theme_void()

```

## Supplemental Material

### Table of model variables

```{r construct variable summary table}
# Each variable that was considered in the modeling process
# Note that some of these values were excluded from the model development process because of suspected unreasonable outliers. Will need to update this once I determine where in the pipeline to trim these data.

summerizer <- function(var){
  colnum <- match(var[1], colnames(habs))
  dat    <- pull(habs, colnum)
  tibble(Variable = var[2],
         Units = var[3],
         Min = min(dat, na.rm = TRUE),
         Med = median(dat, na.rm = TRUE),
         Mean = mean(dat, na.rm = TRUE),
         Max = max(dat, na.rm = TRUE),
         Scale = var[4],
         Source = var[5]
         )
}

vec_list <- list(
  c("B_G_DENS", "Cyanobacteria", "cells/mL", "Lake", "NLA"),
  c("MICX", "Microcystin", "ug/L", "Lake", "NLA"),
  c("PTL", "Total Phosphorus", "ug/L", "Lake", "NLA"),
  c("NTL", "Total Nitrogen", "mg N/L", "Lake", "NLA"),
  c("NITRATE_N", "Nitrate", "mg N/L", "Lake", "NLA"),
  c("AMMONIA_N", "Ammonium", "mg N/L", "Lake", "NLA"),
  c("DOC", "Dissolved Organic Carbon", "mg/L", "Lake", "NLA"),
  c("PH", "pH", "Std. Units", "Lake", "NLA"),
  c("TURB", "Tubidty", "NTU", "Lake", "NLA"),
  c("EVAP_INFL", "Evaporation:Inflow", "unitless", "Lake", "NLA"),
  c("MAXDEPTH", "Maximum Lake Depth", "meters", "Lake", "NLA"),
  c("lakemorpho_fetch", "Lake Fetch", "meters", "Lake", "Lakemorpho"),
  c("N_Fert_Farm", "Farm Fertilizer N", "kg/ha/yr", "Watershed", "National Nutrient Inventory"),
  c("N_livestock_Waste", "Livestock Waste N", "kg/ha/yr", "Watershed", "National Nutrient Inventory"),
  c("N_CBNF", "Cultivated Crop Biological Nitrogen Fixation", "kg/ha/yr", "Watershed", "National Nutrient Inventory"),
  c("P_f_fertilizer", "Farm Fertilizer P", "kg/ha/yr", "Watershed", "National Nutrient Inventory"),
  c("P_livestock_Waste", "Livestock Waste P", "kg/ha/yr", "Watershed", "National Nutrient Inventory"),
  c("N_Human_Waste", "Human Waste N", "kg/ha/yr", "Watershed", "National Nutrient Inventory"),
  c("N_Fert_Urban", "Non-Farm Fertilizer N", "kg/ha/yr", "Watershed", "National Nutrient Inventory"),
  c("P_human_waste_kg", "Human Waste P", "kg/ha/yr", "Watershed", "National Nutrient Inventory"),
  c("P_nf_fertilizer", "Non-Farm Fertilizer P", "kg/ha/yr", "Watershed", "National Nutrient Inventory"),
  c("n_farm_inputs", "Total Farm N Inputs", "kg/ha/yr", "Watershed", "National Nutrient Inventory"),
   c("p_farm_inputs", "Total Farm P Inputs", "kg/ha/yr", "Watershed", "National Nutrient Inventory"),
   c("n_dev_inputs", "Total Developed N Inputs", "kg/ha/yr", "Watershed", "National Nutrient Inventory"),
   c("p_dev_inputs", "Total Developed P Inputs", "kg/ha/yr", "Watershed", "National Nutrient Inventory"),
  c("fst_ws", "Forested Land Cover", "percent", "Watershed", "NLCD 2011"),
  c("BFIWs", "Baseflow Index", "unitless", "Watershed", "LakeCat"),
  c("precip_mean_month", "Month Mean Precipitation", "millimeters", "Watershed", "LakeCat"),
  c("temp_mean_month", "Month Mean Temperature", "degC", "Watershed", "LakeCat"),
  c("Precip8110Ws", "Mean Annual Precipitation", "millimeters", "Watershed", "LakeCat"),
  c("Tmean8110Ws", "Mean Annual Temperature", "millimeters", "Watershed", "LakeCat")
)

summary_covariate_table <- do.call(rbind, lapply(vec_list, summerizer)) |>
  mutate(Type = c(rep("In-Lake Conditions", 10), 
                  rep("Lake Geometry", 2), 
                  rep("Nutrient Inputs", 14), 
                  rep("Geographic Setting", 5)), .before = "Variable")

options(digits = 1)
covar_sum_table <- summary_covariate_table |>
  flextable() |>
  colformat_num(j = c("Min","Med","Mean","Max"), digits = 2, part = "body") |>
  merge_v(part = "body", j = 1) |> 
  theme_booktabs(bold_header = TRUE) |>
  theme_box() |>
  align(align = "center", part = "header") |>
  align(align = "center", j = 1, part = "body") |>
  fontsize(size = 10, part = "body") |>
  fontsize(size = 10, part = "header")

```

```{r varable summary table}
#| label: tbl-var-summary
#| tbl-cap: Summary statistics for response variable and covariates in the model.
covar_sum_table
```

```{r model selection tables}

# Create a table of model comparison process
tabs <- c("cyano_mod_compare_withlakedata.rds",
          "cyano_mod_compare_nolakedata.rds",
          "micx_iemod_compare_withlakedata.rds",
          "micx_iemod_compare_nolakedata.rds",
          "micx_spmod_compare_withlakedata.rds",
          "micx_spmod_compare_nolakedata.rds")

# Vector of strings to replace with covariate names
covar_labs <-  c("NTL" = "Total N",
                 "PTL" = "Total P",
                 "NITRATE_N" = "Nitrate",
                 "AMMONIA_N" = "Ammonium",
                 "DOC" = "DOC",
                 "TURB" = "Turbidity",
                 "PH" = "pH",
                 "EVAP_INFL" = "Evaporation/Inflow",
                 "MAXDEPTH" = "Lake Depth",
                 "lakemorpho_fetch" = "Lake Fetch",
                 "n_farm_inputs" = "Farm N Inputs",
                 "p_farm_inputs" = "Farm P Inputs",
                 "n_dev_inputs" = "Developed N Inputs",
                 "p_dev_inputs" = "Developed P Inputs",
                 "fst_ws" = "Forest Cover",
                 "BFIWs" = "Baseflow Index",
                 "Precip8110Ws" = "Annual Precip",
                 "Tmean8110Ws" = "Annual Air Temp",
                 "precip_mean_month" = "Monthly Precip",
                 "temp_mean_month" = "Monthly Air Temp",
                 "AG_ECO3PLNLOW" = "Ecoregion",
                 "AG_ECO3EHIGH" = "Ecoregion",
                 ":" = " * ")

# A few expressions end up being repeated when there are interactions with ecoregion
# rep_expr <- c("Total N * Ecoregion", "Farm N Inputs * Ecoregion", "Farm P Inputs * Ecoregion")

# The columns to be displayed from each table
cyano_cols   <- c("BIC", "bias", "RMSPE", "cor2")
micx_ie_cols <- c("BIC", "bias", "RMSPE", "AUC")
micx_sp_cols <- c("bias", "RMSPE", "AUC")

cyano_labs   <- c("BIC", "Bias", "RMSPE", "R^2")
micx_ie_labs <- c("BIC", "Bias", "RMSPE", "AUC")
micx_sp_labs <- c("Bias", "RMSPE", "AUC")

# Construct the tables
options(digits = 2)
mod_comp_tabs <- lapply(tabs, function(tab){

  # Columns to display in the table
  cols_sel <- if(grepl("cyano", tab)){list(cyano_cols, cyano_labs)
  } else if(grepl("micx_ie", tab)) {list(micx_ie_cols, micx_ie_labs)
  } else {list(micx_sp_cols, micx_sp_labs)}
  
  # Read in table and format
  dat <- readRDS(paste0(here(), "./inst/model_objects/", tab)) |>
    # Insert breaks so that variables are stacked vertically
    mutate(distinct_vars = gsub(", ", " \n", distinct_vars),
           common_vars = gsub(", ", " \n", common_vars),
           # Maps variable strings to the desired labels
           distinct_vars = str_replace_all(distinct_vars, covar_labs),
           common_vars = str_replace_all(common_vars, covar_labs),
           # Removes duplicated labels using regular expressions (note, this does not capture expressions that have an *)
           distinct_vars = str_replace_all(distinct_vars, "\\b(\\w+)\\s+\\1\\b", "\\1"),
           common_vars = str_replace_all(common_vars, "\\b(\\w+)\\s+\\1\\b", "\\1"))|>
    arrange(model) |>
    select(common_vars, distinct_vars, all_of(cols_sel[[1]]))
  
  # Set the header
  dat_header <- data.frame(
    col_keys = colnames(dat),
    line2 = c(rep("Model Fixed Effects", 2), cols_sel[[2]]),
    line3 = c("Common Set", "Test Set", cols_sel[[2]])
  )
  
  # Table caption builder
  inlake <- ifelse(grepl("nolakedata", tab), "absent", "present")
  error  <- ifelse(grepl("iemod", tab), "independent", "spatial")
  resp   <- ifelse(grepl("cyano", tab), "cyanobacteria", "microcystin")
  cap    <- paste("Model selection for the", resp, "model with in-lake conditions", inlake, "and a", error, "error structure. Fixed effects that are common to all candidate models are listed under Common Set and those that are unique to the model are listed under Test Set.")
  
  # Format the table
  flex_dat <- dat |>
    flextable() |>
    set_header_df(mapping = dat_header, key = "col_keys" ) |>
    merge_v(part = "header", j = c(3:length(dat))) |> 
    merge_h(part = "header", i = 1) |>
    merge_v(part = "body", j = 1) |>
    theme_booktabs(bold_header = TRUE) |>
    fontsize(size = 10, part = "body") |>
    fontsize(size = 10, part = "header") |>
    theme_box() |>
    align(align = "center", part = "header") |>
    autofit(add_w = 0, add_h = 0) |>
    paginate(init = TRUE, hdr_ftr = TRUE)
  
    return(list(cap, flex_dat))
})


```

`r mod_comp_tabs[[1]][[1]]` `r mod_comp_tabs[[1]][[2]]`

`r mod_comp_tabs[[2]][[1]]` `r mod_comp_tabs[[2]][[2]]`

`r mod_comp_tabs[[3]][[1]]` `r mod_comp_tabs[[3]][[2]]`

`r mod_comp_tabs[[5]][[1]]` `r mod_comp_tabs[[5]][[2]]`

`r mod_comp_tabs[[5]][[1]]` `r mod_comp_tabs[[5]][[2]]`

`r mod_comp_tabs[[4]][[1]]` `r mod_comp_tabs[[4]][[2]]`

`r mod_comp_tabs[[6]][[1]]` `r mod_comp_tabs[[6]][[2]]`

```{r}

# load predictor dataset into quarto

load("C:/Users/mreyno04/OneDrive - Environmental Protection Agency (EPA)/Profile/REPOS/HABsDrivers/data/PredData.rda")

# load water boundary data 

load("C:/Users/mreyno04/OneDrive - Environmental Protection Agency (EPA)/Profile/REPOS/HABsDrivers/inst/source_data/wbd_copy.rda")


```

```{r cyano predictions}

# Cyano Predictions Map

PredData <- PredData %>%
  mutate(disc_cyano = factor(case_when(pred_cyano[, "fit"] < 4.41497 ~ 'B1', # under 25k
                                       pred_cyano[, "fit"] >= 4.41497 & pred_cyano[, "fit"] < 4.70757 ~ 'B2', # 25k - 50k
                                       pred_cyano[, "fit"] >= 4.70757 & pred_cyano[, "fit"] < 5.00432 ~ 'B3', # 50k - 100k
                                       pred_cyano[, "fit"] >= 5.00432 & pred_cyano[, "fit"] < 5.39967 ~ 'B4', # 100k - 250k
                                       pred_cyano[, "fit"] >= 5.39967 & pred_cyano[, "fit"] < 5.69984 ~ 'B5', # 250k-500k
                                       pred_cyano[, "fit"] > 5.69984 ~ 'B6', # 500k
                                       TRUE ~ NA),
                             levels = c('B1', 'B2', 'B3', 'B4', 'B5', 'B6'))) %>%
  arrange(disc_cyano)

sub_25 <- PredData %>%
  filter(disc_cyano == 'B1')

cyano_labels <- c('< 25', '25 - 50', '50 - 100', '100 - 250', '250 - 500', ' > 500')
cyano_colors <- c("#21618C","#5499C7","#A9CCE3","#EDBB99","#DC7633","#A04000")

ggplot() +
  geom_sf(data = PredData,
          aes(color = disc_cyano),
          size = 0.3,
          alpha = 0.8) +
  scale_color_manual(values = cyano_colors,
                     labels = cyano_labels,
                     name = "Abundance (1000 cells/mL)") +
  geom_sf(data = sub_25,
          aes(color = disc_cyano),
          size = 0.3,
          alpha = 0.8)  +
  #geom_sf(data = states, fill = NA, color = "black", lwd = 0.1) +
  theme_void() +
  theme(axis.title.y=element_blank(),
        legend.position = "none")

```

```{r micx predictions}

# Micx Prediction Maps 

PredData <- PredData %>%
  arrange(pred_micx[, "fit"])

labels = c("0-25", "25-50", "50-75", "75-100")
breaks <- c(0.25,0.50,0.75,1.0)
micx_colors <- c("#2980b9","#aed6f1","#f0b27a","#d35405")

ggplot(PredData, aes(color = pred_micx[, "fit"])) +
  geom_sf(size = 0.3) +
  scale_color_stepsn(colors = micx_colors,
                     breaks = breaks,
                     labels = labels,
                     name = "Probability of Detection (%)") +
  #geom_sf(data = states, fill = NA, color = "black", lwd = 0.1) +
  theme_void() +
  theme(axis.title.y=element_blank(),
        legend.position = "none")

```

```{r prepare data - micx}

comp_micx <- st_join(wbd_copy, PredData) |>
  dplyr::select(-c(pred_cyano, cyano_transform, COMID.x)) |>
  rename(COMID = COMID.y) |>
  drop_na(pred_micx)

comp_micx <- comp_micx |>
  mutate(all_pred = factor(case_when(
    (n_dev_inputs >= 10 | p_farm_inputs >= 4) & pred_micx[, "fit"] >= 0.50 ~ 'HNHM',
    (n_dev_inputs < 10 | p_farm_inputs < 4) & pred_micx[, "fit"] >= 0.50 ~ 'LNHM',
    (n_dev_inputs >= 10 | p_farm_inputs >= 4) & pred_micx[, "fit"] < 0.50 ~ 'HNLM',
    (n_dev_inputs < 10 | p_farm_inputs < 4) & pred_micx[, "fit"] < 0.50 ~ 'LNLM',
    TRUE ~ 'OTHER'),
    levels = c('HNHM','HNLM','LNHM','LNLM'))) %>%
    arrange(all_pred)

# create custom area:depth ratio
for (Shape in 1:length(comp_micx)) {
  shapes <- comp_micx$Shape
  comp_micx$custom_area <- st_area(shapes)
}

comp_micx$custom_area <- units::drop_units(comp_micx$custom_area)
comp_micx <- comp_micx |>
  mutate(area_ha = (custom_area / 10000))

comp_micx <- comp_micx %>%
  mutate(area_km = custom_area / 1000000,
         ad_ratio = (sqrt(area_km)) / MAXDEPTH) 

# Only run after area has been calculated, return geographic information to point data
comp_micx$Shape <- st_point_on_surface(comp_micx$Shape)|>
  st_transform(crs=5072)


```

```{r prepare data - cyano}

comp_cyano <- st_join(wbd_copy, PredData) |>
  dplyr::select(-c(pred_micx, micx_transform, COMID.x)) |>
  rename(COMID = COMID.y) |>
  drop_na(pred_cyano)

comp_cyano <- comp_cyano |>
  mutate(all_pred = factor(case_when(
    (n_farm_inputs >= 10 | p_dev_inputs >= 4) & pred_cyano[, "fit"] >= 5 ~ 'HNHC',
    (n_farm_inputs < 10 | p_dev_inputs < 4) & pred_cyano[, "fit"] >= 5 ~ 'LNHC',
    (n_farm_inputs >= 10 | p_dev_inputs >= 4) & pred_cyano[, "fit"] < 5 ~ 'HNLC',
    (n_farm_inputs < 10 | p_dev_inputs < 4) & pred_cyano[, "fit"] < 5 ~ 'LNLC',
    TRUE ~ 'OTHER'),
    levels = c('HNHC','HNLC','LNHC','LNLC'))) %>%
    arrange(all_pred)

# create custom area:depth ratio
for (Shape in 1:length(comp_cyano)) {
  shapes <- comp_cyano$Shape
  comp_cyano$custom_area <- st_area(shapes)
}

comp_cyano$custom_area <- units::drop_units(comp_cyano$custom_area)
comp_cyano <- comp_cyano |>
  mutate(area_ha = (custom_area / 10000))

comp_cyano <- comp_cyano %>%
  mutate(area_km = custom_area / 1000000,
         ad_ratio = (sqrt(area_km)) / MAXDEPTH)

# Only run after area has been calculated, return geographic information to point data
comp_cyano$Shape <- st_point_on_surface(comp_cyano$Shape)|>
  st_transform(crs=5072)

```

```{r density plots - precip}

cat_labels <- c('High Nutrient, High HABs',
                    'High Nutrient, Low HABs',
                    'Low Nutrient, High HABs',
                    'Low Nutrient, Low HABs')

precip_den_micx <- ggplot(comp_micx, aes(x=Precip8110Ws, y= all_pred)) +
  ggridges::geom_density_ridges(aes(fill = all_pred),
                                scale = 2,
                                alpha = 0.85,
                                quantile_lines = TRUE, quantiles = 2) +
  scale_fill_manual(values = c("#9c0082","#cc6de4","#4e8562", "#8bd1a5"),
                    labels = cat_labels) +
    xlim(0,2000) +
  labs(x = "Precipitation (mm)", fill = 'Class',
       title = 'Microcystin') +
  theme(axis.title.y=element_blank(),
        legend.position = "none")

precip_den_cyano <- ggplot(comp_cyano, aes(x=Precip8110Ws, y= all_pred)) +
  ggridges::geom_density_ridges(aes(fill = all_pred),
                                scale = 2,
                                alpha = 0.85,
                                quantile_lines = TRUE, quantiles = 2) +
  scale_fill_manual(values = c("#9c0082","#cc6de4","#4e8562", "#8bd1a5"),
                    labels = cat_labels) +
  xlim(0,2000) +
  labs(x = "Precipitation (mm)", y = "Density Distribution",  fill = 'Class',
       title = 'Cyanobacteria') +
  guides(color = guide_legend(ncol=2, override.aes = list(size=4, shape = 15))) +
  theme(axis.title.y=element_blank(),
        legend.position = "none")


ggpubr::ggarrange(precip_den_cyano, precip_den_micx,
                  ncol = 2, nrow = 1,
                  common.legend = TRUE)
```

```{r density plots - baseflow}

baseflow_den_micx <- ggplot(comp_micx, aes(x=BFIWs, y= all_pred)) +
  ggridges::geom_density_ridges(aes(fill = all_pred),
                                scale = 2,
                                alpha = 0.85,
                                quantile_lines = TRUE, quantiles = 2) +
  scale_fill_manual(values = c("#9c0082","#4e8562", "#cc6de4", "#8bd1a5"),
                    labels = cat_labels) +
  xlim(0,100) +
  labs(x = "BaseFlow (%)", fill = 'Class',
       title = 'Microcystin') +
  theme(axis.title.y=element_blank())

baseflow_den_cyano <- ggplot(comp_cyano, aes(x=BFIWs, y= all_pred)) +
  ggridges::geom_density_ridges(aes(fill = all_pred),
                                scale = 2,
                                alpha = 0.85,
                                quantile_lines = TRUE, quantiles = 2) +
  scale_fill_manual(values = c("#9c0082","#4e8562", "#cc6de4", "#8bd1a5"),
                    labels = cat_labels) +
  xlim(0,100) +
  labs(x = "BaseFlow (%)", y = "Density Distribution",  fill = 'Class',
       title = 'Cyanobacteria') +
  theme(axis.title.y=element_blank()) +
  guides(color = guide_legend(ncol=2, override.aes = list(size=4, shape = 15)))

ggpubr::ggarrange(baseflow_den_cyano, baseflow_den_micx,
                  ncol = 2, nrow = 1,
                  common.legend = TRUE)

```

```{r density plots - a:d ratio}

ad_den_micx <- ggplot(comp_micx, aes(x=ad_ratio, y= all_pred)) +
  ggridges::geom_density_ridges(aes(fill = all_pred),
                                scale = 2,
                                alpha = 0.85,
                                quantile_lines = TRUE, quantiles = 2) +
  scale_fill_manual(values = c("#9c0082","#4e8562", "#cc6de4", "#8bd1a5")) +
  xlim(0,0.5) +
  labs(x = "Area:Depth Ratio", fill = 'Class',
       title = 'Microcystin') +
  theme(axis.title.y=element_blank())

ad_den_cyano <- ggplot(comp_cyano, aes(x=ad_ratio, y= all_pred)) +
  ggridges::geom_density_ridges(aes(fill = all_pred),
                                scale = 2,
                                alpha = 0.85,
                                quantile_lines = TRUE, quantiles = 2) +
  scale_fill_manual(values = c("#9c0082","#4e8562", "#cc6de4", "#8bd1a5")) +
  xlim(0,0.5) +
  labs(x = "A:D Ratio", y = "Density Distribution",  fill = 'Class',
       title = 'Cyanobacteria') +
  theme(axis.title.y=element_blank())

ggpubr::ggarrange(ad_den_micx, ad_den_cyano,
                  ncol = 2, nrow = 1,
                  common.legend = TRUE)
```

---
title: "Spatial Modeling of Cyanobacteria Bloom Risk to Disentangle Nutrients and Other Drivers for 125,000 Lakes in the USA"
format: docx
authors: Amalia Handler, Michael Dumelle, and Melanie Reynolds
editor: visual
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
# Load model development data
devtools::load_all()

# Load packages
library(readr)
library(here)
library(spmodel)
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggpubr)
library(sf)
library(tigris)
library(knitr)
library(here)
library(corrplot)
library(flextable)
library(officer)
library(officedown)
library(stringr)
library(ggbeeswarm)
library(ggnewscale)

# Do not include code chunks in document
knitr::opts_chunk$set(echo = FALSE, message = FALSE)

# Load model objects
cyano_lake <- readRDS(paste0(here(), "/inst/model_objects/model_cyano_withlakedata.rds"))
micx_lake  <- readRDS(paste0(here(), "/inst/model_objects/model_micx_withlakedata.rds"))

cyano_nolake <- readRDS(paste0(here(), "/inst/model_objects/model_cyano_nolakedata.rds"))
micx_nolake  <- readRDS(paste0(here(), "/inst/model_objects/model_micx_nolakedata.rds"))

# Load covariate attribution tables that have the slope * variable value for each fixed effect in the model
cov_cyan <- read_csv(here("inst/model_objects/cyano_nolake_attribution.csv"))
cov_micx <- read_csv(here("inst/model_objects/micx_nolake_attribution.csv"))

# Load the conterminous US shapefile with state outlines
conus <- tigris::states(cb = TRUE, progress_bar = FALSE) |>
  filter(!STUSPS %in% c('HI', 'PR', 'AK', 'MP', 'GU', 'AS', 'VI')) |>
  st_transform(crs = 5072)

# p-value results for models with lake conditions
pval <- function(x){ifelse(x < 0.001, "p<0.001", paste0("p=",round(x, 3)))}

doc_cyano <- pval(summary(cyano_lake)$coefficients$fixed$p[5])
doc_micx  <- pval(summary(micx_lake)$coefficients$fixed$p[4])
int_cyano_plnlow <- pval(summary(cyano_lake)$coefficients$fixed$p[15])


```

## Methods

The process for our analysis was (1) data compilation, (2) model fitting, (3) model comparison for (a) models with in-lake data present versus absent and (b) spatial versus independent error models, (4) model prediction, and (5) analysis of model predictions (@fig-schematic).

```{r}
#| label: fig-schematic
#| fig-width: 1
#| fig-height: 1
#| fig-cap: "Schematic diagram of methods. The goal of model fitting was to identify a set of covariates that best explain national patterns in cyanobacteria and microcystin detection. Model comparison evaluates model performance with in-lake conditions present versus absent and an independent versus spatial error structure. The final models with in-lake conditions absent and spatial error structure were used to generate predictions for new lakes. The prediction analysis focuses on predictions that are consistent with expectations based on modeled nutrient inputs versus predictions that are unexpected based on nutrients."

knitr::include_graphics("Schematic methods diagram.jpg")
```

### Data Compilation

We incorporated data at both the lake and watershed scale. We used data from the National Lakes Assessment (NLA)(Pollard et al. 2018), National Nutrient Inventory (NNI)(Sabo et al. 2019, 2021b, 2021a), National Land Cover Database (NLCD)(Dewitz and U. S. Geological Survey 2021), PRISM climate data (Daly et al. 2008), and several watershed variables from the LakeCat dataset (Hill et al. 2018); Table S1).

#### In-Lake Conditions from the National Lakes Assessment

The NLA, part of the broader US EPA’s National Aquatic Resource Survey (NARS) program (www.epa.gov/national-aquatic-resource-surveys), assesses the physical, chemical, and biological condition of lakes across CONUS (Peck et al. 2020). Every five years, a set of lakes are sampled according to a spatially balanced, probability-based survey design (Stevens and Olsen 2003, 2004, Dumelle et al. 2023). For the first NLA in 2007, the target population (i.e., population of interest) included lakes at least 4 ha in surface area and at least 1 m deep. From 2012 onward, the NLA target population was expanded to include lakes at least 1 ha in surface area. Each surveyed year, approximately 1,000 lakes are sampled once between June and September. In addition, approximately 10% of lakes are sampled a second time for the purposes of evaluating sample variability over the sampling period.

Complete methods are available in technical documentation for the survey (US EPA 2022). Briefly, samples for surface water properties and phytoplankton characterization are collected by boat at the deepest point in the lake. An integrated euphotic zone sample of the water column is used for species-level phytoplankton identification (US EPA 2017). The microscope method requires identifying and enumerating 400 natural algal units per sample including colonies. The cyanotoxin microcystin was measured using a microtiter plate enzyme linked immuno-sorbent assay (ELISA), where the detection limit is 0.1 μg/L. Samples for microcystin were subject to three freeze-thaw cycles to lyse cells and release toxins into the dissolved phase prior to measurement (US EPA 2017). These samples were also analyzed for total nitrogen (TN), total phosphorus (TP), nitrate, ammonium, dissolved organic carbon (DOC), turbidity, and pH. From these water samples, stable isotopes of hydrogen and oxygen were also measured, and this information was used to estimate evaporation-to-inflow ratio for the lake (Brooks et al. 2014). Finally, a vertical profile that includes temperature and a maximum depth measurement is collected. We used data from the 2007, 2012, and 2017 NLA for this analysis (@fig-nla-map). Cyanobacteria abundance was calculated by summing the abundance of all cyanobacteria taxa identified in each sample. We calculated surface water temperature by taking the mean of the top two meters of the water column profile or the entire depth of the lake, whichever was shorter. 

```{r nla map, message = FALSE}
#| label: fig-nla-map
#| fig-width: 7.5
#| fig-height: 7.5
#| fig-cap: "Lakes sampled in the 2007, 2012, and 2017 National Lakes Assessment with the observed (a) cyanobacteria abundance and (b) microcystin presence by three major ecoregions."

nla_vis_cyan <- habs |>
  mutate(disc_cyano = factor(case_when(B_G_DENS < 25000 ~ 'B1', # under 25k
                                       B_G_DENS >= 25000 & B_G_DENS < 50000 ~ 'B2', # 25k - 50k
                                       B_G_DENS >= 50000 & B_G_DENS < 100000 ~ 'B3', # 50k - 100k
                                       B_G_DENS >= 100000 & B_G_DENS < 250000 ~ 'B4', # 100k - 250k
                                       B_G_DENS >= 250000 & B_G_DENS < 500000 ~ 'B5', # 250k-500k
                                       B_G_DENS >= 500000 ~ 'B6', # 500k
                                       TRUE ~ NA),
                             levels = c('B1', 'B2', 'B3', 'B4', 'B5', 'B6'))) |>
  drop_na(disc_cyano) |>
  arrange(disc_cyano)

nla_vis_micx <- habs |>
  drop_na(MICX_DET) |>
  mutate(MICX_DET = factor(MICX_DET, levels = c("0", "1"))) |>
  arrange(MICX_DET)

cyano_labels <- c('< 25', '≥ 25 - 50', '≥ 50 - 100', '≥ 100 - 250', '≥ 250 - 500', '≥ 500')
cyano_colors <- c("#21618C","#5499C7","#A9CCE3","#EDBB99","#DC7633","#A04000")

# Note that the 3 aggregated ecoregions shapefile has been simplified to a reduced number of vertices and is only intended for data visualization purposes at the national scale.
ecor_map <- ggplot() + 
  geom_sf(data = eco_ag3_simpl, aes(fill = WSA_3_NM), color = "black", alpha = 0.5, size = 0.5) +
  scale_fill_manual(values = c("#f0f0f0", "#636363", "#bdbdbd"),
                      name = "Ecoregion",
                    labels = c("Eastern Highlands", "Plains and Lowlands", "Western")) +
  geom_sf(data = conus, fill = "transparent", color = "black", size = 0.5) # grey fill #e2e2e2

nla_map_cyan <- ecor_map +
  new_scale_fill() +
  geom_sf(data = nla_vis_cyan, shape = 24, aes(fill = disc_cyano), size = 1.75, stroke = 0.2) +
  scale_fill_manual(values = cyano_colors,
                    labels = cyano_labels,
                    name = "Cyanobacteria \nAbundance \n(1000 cells/mL)") +
  theme_void()

nla_map_micx <- ecor_map +
  guides(fill = "none") +
  new_scale_fill() +
  geom_sf(data = nla_vis_micx, shape = 24, aes(fill = MICX_DET), size = 1.75, stroke = 0.2) +
  scale_fill_manual(values = c("#2980b9","#d35405"),
                    labels = c("Not Detected", "Detected"),
                    name = "Microcystin") +
  
  theme_void()

ggarrange(plotlist = list(nla_map_cyan, nla_map_micx), ncol = 1, nrow = 2, labels = "auto")

```

#### Geographic Setting and Nutrient Inputs

We retrieved watershed characteristics from the LakeCat dataset including mean annual precipitation and air temperature (PRISM), mean annual precipitation minus evapotranspiration and mean annual runoff (Pennino et al. 2020), baseflow index (McCabe and Wolock 2011), soil erodibility factor (Wolock 1997), and forested and wetland land cover (NLCD).  We calculated mean watershed precipitation and air temperature for months in which sampling occurred based on PRISM data. Each lake was associated with one of three CONUS ecoregions: Eastern Highlands, Plains and Lowlands, and Western regions (Omernik and Griffith 2014).

We compiled annually summarized watershed nutrient inputs of nitrogen and phosphorus from the NNI by taking the mean of the years 2002, 2007, and 2012 (Sabo et al. 2019, 2021b, 2021a). The mean was used since the national-scale patterns in the NNI over this period were fairly stable (Sabo et al. 2019, 2021b) and NNI data were not available for 2017 at the time of the analysis. We aggregated variables to form composites, which simultaneously reduces both the number of overall variables in our models as well as the correlation among remaining variables. The aggregated variables are total farm nitrogen inputs (farm fertilizer, manure, and crop nitrogen fixation), total farm phosphorus inputs (farm fertilizer and manure), total developed nitrogen inputs (non-farm fertilizer and human waste), and total developed phosphorus inputs (non-farm fertilizer and human waste).

#### Lake Geometry

Lake depths were compiled from multiple data sources using a tiered approach. Priority was given to in-situ lake depth measurements from the NLA and the LAGOS-US datasets (Cheruvelil et al. 2021). Next, estimated lake depths were retrieved from the NHDPlusV2 (McKay et al. 2012, Hollister and Stachelek 2017). For the 12,380 remaining lakes that lacked depth information, we estimated depth based on surrounding topography using the elevatr and Lakemorpho R packages (Hollister and Stachelek 2017, Hollister 2023). We retrieved lake surface area from the NHDPlusV2 waterbody boundary data. Lake fetch, or the maximum length between two points on the shoreline, was calculated using the Lakemorpho R package. We also calculated the lake surface area to maximum lake depth (area:depth ratio) (Håkanson 1982). We calculated the area:depth ratio as the square root of the surface area divided by the lake depth.

### Statistical Modeling

We used a statistical modeling approach incorporating spatial dependence (i.e., a spatially explicit approach), which offers distinct advantages to modeling and predicting lakes at risk for cyanoHABs at regional and national scales. These spatial models handle the non-independence of lakes with varying proximities to one another by formally building spatial autocorrelation directly into the model structure (Cressie 2015). A key benefit of this approach is that spatial autocorrelation can capture the influence of spatially structured variables that are not explicitly included in the model due to a lack of available, fine-scale spatial data. This capability allows the model to account for local to regional factors that may affect the incidence of cyanoHABs but are not necessarily important on a national scale (Dumelle et al. 2024).

We used the spmodel R package (Dumelle et al., 2023) to build two separate frequentist models: (1) cyanobacteria abundance which was fit using a spatial linear model and (2) presence of microcystin which was fit using a spatial logistic model to estimate the probability of microcystin detection. Cyanobacteria abundance has a high degree of right skew and was log10-transformed. To preserve zero values (non-detection) we added a constant (c) to the cyanobacteria abundance prior to log-transforming. Using an algorithm to choose a value of c that satisfies (approximately) important statistical constraints (Berry 1987), we set c = 1,000. This choice of c maintained relative closeness on the log scale among small values in the data. Two models were constructed for each response variable (cyanobacteria abundance or microcystin detection) for a total of four models. First, a model was fit that included the in-lake conditions in addition to watershed and lake characteristics (Figure 1). A second model was fit that excluded the in-lake conditions, leaving only GIS-derived watershed and lake covariates. All models included two random effects, one for the survey year and one for the unique lake identifier to account for variation from resampling a unique site across or within survey years.

#### Selection of Model Covariates

For each model, we compared six candidate models with different sets of fixed effects drawn from four categories: water physio-chemical conditions (only for models with in-lake conditions included), lake morphology, watershed nutrient inputs, and geographic setting. Since many of the candidate variables are correlated (see Figure 3), we took the approach of selecting 1-3 variables from each category for an initial model. Covariate selection was based on sets of variables that were shown in the literature or are hypothesized to have a relationship to lake cyanoHABs. We then tested whether substitution of variables for other correlated variables would improve model fit. For example, we tested whether farm nitrogen inputs were a better fit than farm phosphorus inputs or whether the mean annual temperature was a better fit than the mean temperature for the month. Likewise, we also tested whether the addition of covariates improved model fit. For example, we tested whether the addition the forested land cover in the watershed or the ecoregion would improve model fit. Model fit was assessed based on Bayesian Information Criterion (BIC) and area under the receiver operating curve (AUC; see below). 

For the cyanobacteria abundance models, each candidate model was fit using the same set of observations with maximum likelihood estimation. For each model, we ran a leave one out cross validation (LOOCV) to calculate the model bias, root mean squared prediction error (RMSPE), and predictive R2 (James et al. 2013). The final model was chosen based on which had the lowest BIC (Schwarz 1978). Replicating the cyanobacteria model selection process for the logistic microcystin models was computationally prohibitive because the spatial error structure yields a complicated likelihood function (Ver Hoef et al. 2024). Thus, for microcystin, an initial set of six independent error models were run with maximum likelihood estimation. From the initial set of models, we selected the three candidate models with the lowest BIC to fit using a spatial error structure. The final three models were evaluated with LOOCV to calculate the model bias, RMSPE, and AUC (Robin et al. 2011). The final model selected had the highest AUC. When the AUC was the same among the three candidate models, the model with the simplest formulation (fewest terms) was chosen as the final model. We visually assessed the decorrelated residuals (i.e., standardized) for spatial patterns and extreme values in maps to check assumptions in the same way response residuals can be used to check assumptions in nonspatial models.

#### Model Comparison

For the final selected models, we ran independent error (i.e., nonspatial) models with the same set of covariates to compare to the spatial models with respect to bias, RMSPE, predictive R2 for cyanobacteria abundance, and AUC for microcystin detection. In addition, we compared model fit for models that included in-lake conditions versus the models that excluded in-lake conditions to investigate how the presence of in-lake data impacts model performance.

#### Model Prediction

We predicted cyanobacteria abundance and probability of microcystin detection in 124,529 lakes across the CONUS for the year 2017 using the final spatial models that excluded in-lake conditions. Predictions are generated for the year 2017 because of the random effect for survey year included in the model; however, the predictions are likely representative of the spatial patterns across the country rather than a snapshot in time because much of the data used to generate the predictions is relatively stable over the decade timescale. These lakes are limited to those that are connected to the NHD flowlines due to availability of the NNI dataset. We report the estimated cyanobacteria abundance and probability of microcystin detection with 95% prediction intervals. The predictions from the models for any given lake should be interpreted as the predicted cyanobacteria abundance or probability of microcystin detection in the surface water at the deepest point in the lake one or more times during the June-September period.

### Prediction Analysis

To explore the relationship between cyanoHABs risk, watershed nutrient inputs, and other drivers, we used a categorical framework. The framework is based on the common understanding that excess nutrients are associated with cyanoHABs; however, cyanoHABs are increasingly documented in lakes that challenge this narrative. In other words, cyanoHABs can be found in lakes with low nutrients, or conversely, absent in lakes with high nutrients. To investigate, we divided lakes into “high” and “low” cyanoHABs risk categories and lake watersheds into “higher” and “lower” farm and developed nutrient input categories. We expected lakes with higher farm and developed nutrient inputs to also have high predicted cyanoHABs risk. Similarly, we expected lakes with lower nutrient inputs to have low predicted cyanoHABs risk. Predictions that fall into these categories are consistent with our expectations based on the modeled nutrient inputs alone.  Predictions that are in the other categories—either lower nutrient inputs and high cyanoHABs risk or higher nutrient inputs and low cyanoHABs risk—are inconsistent with our expectations based on farm and developed nutrients alone and provide an opportunity to examine other variables that potentially enhance or mitigate cyanoHABs risk.

For the cutoff between low and high risk for cyanoHABs, we chose 100,000 cells/mL for cyanobacteria abundance and 50% probability of microcystin detection. These cutoffs are for investigative purposes only. The boundary between low and high risk for evaluating ecological or public health risk depends heavily on the impact of concern with cyanoHABs. The 100,000 cells/mL threshold for cyanobacteria has been used in the past to indicate high recreational risk but has since been replaced in favor of approaches linked to toxicity (Chorus and Welker 2021) . Cellular abundance remains a commonly used assessment of cyanobacteria biomass. Our objective is to divide lakes with elevated cyanobacteria levels from those expected to have relatively low levels of cyanobacteria and investigate how this relates to nutrients and other non-nutrient factors. Similarly, for microcystin, we chose the 50% probability cutoff to indicate where summer microcystin detection is more likely than non-detection. For the watershed nutrient inputs, we considered the sum of the farm and developed inputs for N and P separately. For N, this includes farm and non-farm fertilizer, manure, crop biological N fixation, and human waste. For P, this includes farm and non-farm fertilizer, manure, and human waste. We did not include other nutrient sources such as atmospheric deposition, accumulated P inputs, or legacy P inputs because these variables were not included in our final models. For the cutoff between higher and lower annual anthropogenic nutrient inputs, we chose 10 kg ha-1 yr-1 for N and 4 kg ha-1 yr-1 for P. Again, these cutoffs are for investigative purposes only. Together these cyanoHABs and nutrient input cutoffs divide the 124,529 lakes in our dataset into four categories: higher nutrient inputs and high cyanoHAB risk, higher nutrient inputs and low cyanoHAB risk, lower nutrient inputs and high cyanoHAB risk, and lower nutrient inputs and low cyanoHAB risk. 

We investigated the distribution of other non-nutrient variables to gain insights about the characteristics of lakes that fall into each nutrient and cyanoHABs risk category. We examined mean annual precipitation, baseflow index, and area:depth ratio. We plotted the density distribution for each variable within each of the four nutrient-cyanoHABs categories. We used a spatial analysis of variance (ANOVA) to test for differences among means in the nutrient-cyanoHAB categories. We log10 transformed the mean annual precipitation and the area:depth ratio to account for skew in these distributions for the ANOVA.

## Results

```{r corplot prep}
# Trim to just the variables explored in the models
cor_dat <- habs |>
  st_drop_geometry() |>
  select(B_G_DENS, MICX, TEMPERATURE, MAXDEPTH, AMMONIA_N, DOC:NITRATE_N, PH, EVAP_INFL, fst_ws, wet_ws, precip_mean_month, temp_mean_month, lakemorpho_fetch, BFIWs, KffactWs:Precip_Minus_EVTWs, Precip8110Ws, Tmean8110Ws, N_Total_Deposition, P_Deposition, n_farm_inputs:p_dev_inputs, P_Accumulated_ag_inputs, P_Legacy_P) |>
  relocate(B_G_DENS, MICX, NTL, PTL, NITRATE_N, AMMONIA_N, DOC, PH, TEMPERATURE, TURB, EVAP_INFL, fst_ws, wet_ws, KffactWs, n_farm_inputs, p_farm_inputs, P_Accumulated_ag_inputs, P_Legacy_P, n_dev_inputs, p_dev_inputs, N_Total_Deposition, P_Deposition, precip_mean_month, temp_mean_month, Precip8110Ws, Tmean8110Ws, Precip_Minus_EVTWs, RunoffWs, BFIWs, MAXDEPTH, lakemorpho_fetch) 

var_names <- c("Cyanobacteria*", 
               "Microcystin*", 
               "Total N*", 
               "Total P*",   
               "Nitrate*", 
               "Ammonia*", 
               "DOC*", 
               "pH*", 
               "Water Temp*",
               "Turbidity*",
               "Evaporation/Inflow*",
               "Forest Cover", 
               "Wetland Cover",
               "Soil Erodability",
               "Farm N Inputs",
               "Farm P Inputs",
               "Developed N Inputs", 
               "Developed P Inputs",
               "Accumulated P Inputs",
               "Legacy P Inputs",
               "Deposition N",
               "Deposition P",
               "Monthly Precip",
               "Monthly Air Temp",
               "Annual Precip", 
               "Annual Air Temp",
               "Annual Precip-ET",
               "Runoff", 
               "Baseflow Index",
               "Lake Depth",
               "Lake Fetch")

# Reverse from the standard color palette
redblue_palette <- colorRampPalette(c("blue", "white", "red"))

cormat_pred <- cor(cor_dat, use = "pairwise.complete.obs", method = "spearman")

colnames(cormat_pred) <- var_names
rownames(cormat_pred) <- var_names

# How many pairwise comparisons are strongly correlated?
rhos <- as.vector(cormat_pred)

pos_str_rhos <- length(unique(rhos[rhos > 0.5 & rhos < 1]))
neg_str_rhos <- length(unique(rhos[rhos < -0.5 & rhos > -1]))

```

### National Drivers of CyanoHABs

Both the cyanobacteria and microcystin models were driven by a similar set of covariates with some differences in the relative importance of individual covariates within each model. Note that many of the potential covariates tested for the models were highly collinear (@fig-cor-plot). There were `r pos_str_rhos` positive pairwise comparisons that had rho \>0.5 and `r neg_str_rhos` negative pairwise comparisons that had rho \<-0.5. The high degree of correlation among covariates means that the inclusion or exclusion of any variable or influence of any given variable should be interpreted with caution. Indeed, changing the covariates included did not have a large impact on model performance with respect to RMSPE, R^2^ (for cyanobacteria), or AUC (for microcystin; Tables S2-S7).

```{r correlation plot}
#| label: fig-cor-plot
#| fig-width: 6.5
#| fig-height: 6.5
#| fig-cap: "Pairwise spearman’s rank correlation matrix of response variables and continuous covariates considered for the models. Blue represents positive correlations and red represents negative correlations. Darker colors and tighter ellipses represent larger correlation coefficients and stronger relationships. Asterisks denote in-lake variables. See Table S1 for summaries of variable ranges and sources."

# Lower triangle plot
corrplot(cormat_pred, method = "ellipse", type = "lower", 
         tl.col = "black", tl.srt = 45, tl.cex = 0.75,
         col = redblue_palette(100))

```

```{r extract model fixed effects}
# Function to extract the fixed effects from each model
fixed_effect_retriever <- function(model_obj, resp_var, lake_data){
  summary(model_obj)$coefficients$fixed |>
    mutate(fixed_effect = rownames(summary(model_obj)$coefficients$fixed)) |>
    mutate(response_var = resp_var,
           lake_data = lake_data) |>
    tibble() |>
    rename(estimate = estimates) |>
    relocate(response_var, lake_data, fixed_effect, .before = estimate)
}

# Extract the effects
fixed_df <- rbind(
  fixed_effect_retriever(micx_lake, resp_var = "micx", lake_data = "present"),
  fixed_effect_retriever(micx_nolake, resp_var = "micx", lake_data = "absent"),
  fixed_effect_retriever(cyano_lake, resp_var = "cyano", lake_data = "present"),
  fixed_effect_retriever(cyano_nolake, resp_var = "cyano", lake_data = "absent")
)

# Table that includes both response variables and models with and without lake data. Covariates are converted to positive or negative signs with asterisks denoting the associated p-values.
pal <- c("#eb6a7a", "#f08f9b", "#f5b4bc", "#fadade", "#F7F7F7", "#dceaf8", "#b8d5f1", "#95c0eb", "#72abe4")

est_and_sign <- fixed_df |>
  filter(!fixed_effect == "(Intercept)") |>
  mutate(est_sign = ifelse(estimate > 0, "+", "−"),
         sig = case_when(p >= 0.05 ~ "ns",
                         p < 0.05 & p >= 0.01 ~ "*",
                         p < 0.01 & p >= 0.001 ~ "**",
                         p < 0.001 ~ "***"),
         est_sig = paste0(est_sign, " (", sig, ")"),
         fixed_effect = factor(fixed_effect, 
                               levels = c("NTL",
                                          "NITRATE_N",
                                          "AMMONIA_N",
                                          "DOC",
                                          "TURB",
                                          "PH",
                                          "EVAP_INFL",
                                          "n_farm_inputs",
                                          "p_farm_inputs",
                                          "n_dev_inputs",
                                          "p_dev_inputs",
                                          "fst_ws",
                                          "MAXDEPTH",
                                          "lakemorpho_fetch",
                                          "BFIWs",
                                          "Precip8110Ws",
                                          "Tmean8110Ws",
                                          "AG_ECO3PLNLOW",
                                          "AG_ECO3EHIGH",
                                          "NTL:AG_ECO3PLNLOW",
                                          "NTL:AG_ECO3EHIGH"))
         ) |>
  select(response_var:fixed_effect, est_sig) |>
  pivot_wider(names_from = response_var:lake_data,
              values_from = est_sig,
              values_fill = "") |>
  arrange(fixed_effect) |>
  relocate(fixed_effect, cyano_present, micx_present, cyano_absent, micx_absent) |>
  mutate(fixed_effect = c("Total N",
                       "Nitrate",
                       "Ammonium",
                       "DOC",
                       "Turbidity",
                       "pH",
                       "Evaporation/Inflow",
                       "Farm N Inputs",
                       "Farm P Inputs",
                       "Developed N Inputs",
                       "Developed P Inputs",
                       "Forest Cover",
                       "Lake Depth",
                       "Lake Fetch",
                       "Baseflow Index",
                       "Annual Precip",
                       "Annual Air Temp",
                       "Ecoregion PLNLOW",
                       "Ecoregion EHIGH",
                       "Total N * PLNLOW",
                       "Total N * EHIGH"),
         Type = c(rep("In-Lake Conditions", 7),
                  rep("Nutrient Inputs", 5),
                  rep("Lake Geometry", 2),
                  rep("Geographic Setting", 5),
                  rep("Interactions", 2)), .before = fixed_effect
            ) |>
  rename(Covariates = fixed_effect)

colorer <- function(i){
  hex <- case_when(i == "+ (***)" ~ pal[1],
                   i == "+ (**)" ~  pal[2],
                   i == "+ (*)" ~   pal[3],
                   i == "+ (ns)" ~  pal[4],
                   i == "" ~        pal[5],
                   i == "− (ns)" ~  pal[6],
                   i == "− (*)" ~   pal[7],
                   i == "− (**)" ~  pal[8],
                   i == "− (***)" ~ pal[9])
}

est_header <- data.frame(
  col_keys = colnames(est_and_sign),
  line2 = c(rep("Model", 2), rep("In-Lake Conditions", 4)),
  line3 = c(rep("Model", 2), c(rep("Present", 2), rep("Absent", 2))),
  line4 = c("Type", "Covariates", rep(c("Cyano", "Micx"), 2))
)

covar_tbl <- est_and_sign |>
  flextable() |>
  set_header_df(mapping = est_header, key = "col_keys" ) |>
  merge_v(part = "header", j = c(1:2)) |> 
  merge_v(part = "body", j = 1) |> 
  merge_h(part = "header", i = c(1:2)) |> 
  theme_booktabs(bold_header = TRUE) |>
  bg(bg = colorer,
     j = 3:6, # All columns in the body except for the first one
     part = "body") |>
  bg(j = c(5:6), i = c(1:7), bg = "#606060") |> # Covariates that weren't available to the models
  theme_box() |>
  align(align = "center", part = "header") |>
  fontsize(size = 10, part = "body") |>
  fontsize(size = 10, part = "header")

```

Nutrient conditions were important in all models (Table 1). For models that included in-lake conditions, total N was positively related to cyanobacteria abundance and probability of microcystin detection. Nitrate was negatively associated with cyanobacteria and microcystin and ammonium was also negatively associated with cyanobacteria. Dissolved organic carbon was negatively associated with cyanobacteria and microcystin in the models in contrast to the pairwise correlations where DOC was positively correlated with cyanobacteria and microcystin. The microcystin model with in-lake conditions has a positive association with farm P input. For the models that excluded in-lake conditions, the watershed nutrient inputs became more important, with both farm and developed N and P inputs having a positive relationship with cyanobacteria abundance and microcystin detection. Only the microcystin model without in-lake conditions had a negative association with forested land cover.

Table 1. Model fixed effect coefficient sign (negative or positive) and p-value (ns \>0.05, \* \<0.05, \*\* \<0.01, \*\*\*\* \< 0.001) for cyanobacteria (Cyano) and microcystin (Micx) models both where in-lake data was present or absent. Grey cells are covariates that were excluded from model development. Empty cells are covariates not included in the model. Brighter colors denote a lower p-value for either positive (pink) or negative (blue) relationships. See Table S8 for coefficient estimates and standard errors. See @fig-covar-contri for standardized coefficients for the fixed effect and the contribution of each fixed effect to the fitted value. 
```{r print covariate table}
covar_tbl
```

Across all models, shallower lakes and lakes with longer fetch were associated with higher cyanobacteria abundance and microcystin detection. Similarly, watersheds with lower mean annual precipitation and higher mean annual temperature were associated with higher cyanobacteria abundance and microcystin detection.

The models with in-lake conditions had a positive relationship with the evaporation to inflow ratio. In other words, lakes with higher evaporation rates relative to inflowing water were higher in cyanobacteria abundance and probability of microcystin detection. The models without in-lake conditions had a negative relationship with the baseflow index, meaning higher baseflow influence was associated with lower cyanobacteria and microcystin detection.

In most models, the amount of cyanobacteria and probability of microcystin detection was higher in the Plains and Lowlands and Eastern Highlands ecoregions compared to the Western ecoregion. In addition, the cyanobacteria model with in-lake conditions includes an interaction term between lake total N and the ecoregion. In this instance, higher total N in the Eastern Highlands is correlated with significantly higher cyanobacteria abundance relative to the Western ecoregion. There was also a negative interaction between total N and the Plains and Lowlands in the same model

### Spatial Influence and Model Fit

For both sets of models that included and excluded in-lake conditions, the decorrelated residuals did not show any obvious signs of extreme behavior suggesting lack of fit (@fig-std-resid-maps).  For the models of cyanobacteria abundance, spatial models outperformed independent error models with a 30% lower RMSPE and more than doubled the predicted R2 regardless of the presence of in-lake conditions (Table 2). For the probability of microcystin detection, spatial models had approximately a 10% reduction in RMSPE and a 10% increase in AUC compared to independent error models.

Table 2. Comparison of model fit where in-lake conditions are present or absent and the error structure is spatial or independent.
```{r model fit comparison}

comp_cyan <- readRDS(paste0(here(), "/inst/model_objects/spatial_compare_cyano.rds")) |>
  rename(fit = cor2)

comp_micx <- readRDS(paste0(here(), "/inst/model_objects/spatial_compare_micx.rds")) |>
  rename(fit = auc)

options(digits = 2)
rbind(comp_cyan, comp_micx) |>
  select(-MSPE, -bias) |>
  mutate(resp_var = case_when(resp_var == "cyano" ~ "Cyanobacteria",
                              resp_var == "micx" ~ "Microcystin"),
         lake_data = case_when(lake_data == "present" ~ "Present",
                               lake_data == "absent" ~ "Absent"),
         spatial_mod = case_when(spatial_mod == "spatial" ~ "Spatial",
                                 spatial_mod == "non-spatial" ~ "Independent")) |>
  flextable() |>
  set_header_labels(values = list(
    resp_var = "Response Variable",
    lake_data = "In-Lake Conditions",
    spatial_mod = "Error Structure",
    RMSPE = "RMSPE",
    fit = "Fit")) |>
  merge_v(part = "body", j = c(1:2)) |> 
  footnote(i = 1, j = 5,
           value = as_paragraph("Fit is R^2 for cyanobacteria models and AUC for microcystin models."), ref_symbols = "a", part = "header") |>
  theme_booktabs(bold_header = TRUE) |>
  fontsize(size = 10, part = "body") |>
  fontsize(size = 10, part = "header") |>
  fontsize(size = 9, part = "footer") |>
  theme_box() |>
  align(align = "center", part = "header")

```

The model residuals indicate areas where the response was larger or smaller than expected based on the covariates alone (@fig-spa-resid-maps; @fig-resid-maps-inlake). In the cyanobacteria model, strongly positive spatial residuals are in portions of the northern central plains (North and South Dakota, Nebraska), Midwestern states (Minnesota, Iowa, Wisconsin, Illinois, Michigan, Indiana) and mid-Atlantic regions (North and South Carolina, Virginia, Maryland), suggesting that cyanobacteria abundance was higher than expected under a nonspatial model. In contrast, the spatial residuals are strongly negative in the Northeastern part of the country. The microcystin model spatial residuals were similar with positive residuals in the Midwestern and central northern plains regions in addition to areas in Utah, Arizona, Texas, and Florida, and with negative residuals in the Northeast.  

```{r spatial residuals maps for no-lake models}
#| label: fig-spa-resid-maps
#| fig-width: 6
#| fig-height: 7
#| fig-cap: "Spatial residuals for the cyanobacteria abundance (a) and probability of microcystin detection (b) with in-lake conditions absent. Positive spatial residuals indicate that the fixed effects alone under-estimated cyanobacteria abundance or the probability of microcystin detection. Negative spatial residuals mean the response variables were over-estimated by model fixed effects alone. See Figure S3 for the models where in-lake conditions were present."

cyano_aug <- augment(cyano_nolake) |>
  mutate(spde = fitted(cyano_nolake, type = "spcov")$de,
         resp = "Cyanobacteria") |>
  select(resp, spde)

micx_aug <- augment(micx_nolake) |>
  mutate(spde = fitted(micx_nolake, type = "spcov")$de,
         resp = "Microcystin") |>
  select(resp, spde) |>
  st_transform(st_crs(cyano_aug))
  
spde <- rbind(cyano_aug, micx_aug)

cyan_spde_map <- ggplot() + 
  geom_sf(data = conus, fill = "#e2e2e2", color = "white", lwd = 1) +
  geom_sf(data = cyano_aug, 
          aes(fill = spde), pch = 21, size = 1.5) +
  colorspace::scale_fill_continuous_divergingx(palette = "BrBG", 
                                               mid = 0, 
                                               name = "Spatial\nResiduals") +
    theme_void()

micx_spde_map <- ggplot() + 
  geom_sf(data = conus, fill = "#e2e2e2", color = "white", lwd = 1) +
  geom_sf(data = micx_aug, 
          aes(fill = spde), pch = 21, size = 1.5) +
  colorspace::scale_fill_continuous_divergingx(palette = "BrBG", 
                                               mid = 0, 
                                               name = "Spatial\nResiduals") +
    theme_void()

ggarrange(plotlist = list(cyan_spde_map, micx_spde_map), ncol = 1, nrow = 2, labels = "auto")

```

### Predicted CyanoHABs

Across the CONUS, 62.2% of lakes were predicted to have ≥100,000 cells/mL cyanobacteria abundance (@fig-preds-map). Illinois had the highest proportion of high cyanobacteria risk lakes, with 100% of the lakes in the dataset predicted to be above 100,000 cells/mL. Texas and South Dakota have 99.6% and 98.3% of lakes included in the dataset predicted to be above 100,000 cells/mL, respectively. In contrast, just 14.8% of lakes across the CONUS had a ≥50% probability of microcystin detection. High microcystin probability was concentrated in North and South Dakota, Minnesota, Iowa, and Illinois. North Dakota had the highest proportion of lakes in the dataset above 50% probability of microcystin detection, with 96.3%. Illinois and Iowa followed with 71.1% and 68.5% of lakes above 50% probability of microcystin, respectively.

```{r predictions maps}
#| label: fig-preds-map
#| fig-width: 6
#| fig-height: 8
#| fig-cap: "Predicted cyanobacteria abundance (a) and probability of microcystin detection at or above 0.1 µg/L (b) in 124,529 on-network lakes. Lakes ≥100,000 cells/mL for cyanobacteria abundance or ≥50% probability of microcystin detection shown in warmer colors and lakes below these thresholds are shown in cooler colors."

states <- states(cb = TRUE, progress_bar = FALSE)  %>%
  filter(!STUSPS %in% c('HI', 'PR', 'AK', 'MP', 'GU', 'AS', 'VI'))  %>%
  st_transform(crs = 5072)

# Cyano Predictions Map

PredData <- PredData %>%
  mutate(disc_cyano = factor(case_when(pred_cyano_fit < 4.41497 ~ 'B1', # under 25k
                                       pred_cyano_fit >= 4.41497 & pred_cyano_fit < 4.70757 ~ 'B2', # 25k - 50k
                                       pred_cyano_fit >= 4.70757 & pred_cyano_fit < 5.00432 ~ 'B3', # 50k - 100k
                                       pred_cyano_fit >= 5.00432 & pred_cyano_fit < 5.39967 ~ 'B4', # 100k - 250k
                                       pred_cyano_fit >= 5.39967 & pred_cyano_fit < 5.69984 ~ 'B5', # 250k-500k
                                       pred_cyano_fit >= 5.69984 ~ 'B6', # 500k
                                       TRUE ~ NA),
                             levels = c('B1', 'B2', 'B3', 'B4', 'B5', 'B6'))) %>%
  arrange(disc_cyano)

sub_25 <- PredData %>%
  filter(disc_cyano == 'B1')

cyano_labels <- c('< 25', '≥ 25 - 50', '≥ 50 - 100', '≥ 100 - 250', '≥ 250 - 500', '≥ 500')
cyano_colors <- c("#21618C","#5499C7","#A9CCE3","#EDBB99","#DC7633","#A04000")

cyano_pred_map <- ggplot() +
  geom_sf(data = PredData,
          aes(color = disc_cyano),
          size = 0.3,
          alpha = 0.8) +
  scale_color_manual(values = cyano_colors,
                     labels = cyano_labels,
                     name = "Abundance \n(1000 cells/mL)") +
  geom_sf(data = sub_25,
          aes(color = disc_cyano),
          size = 0.3,
          alpha = 0.8)  +
  geom_sf(data = states, fill = NA, color = "black", lwd = 0.1) +
  guides(color = guide_legend(override.aes = list(size = 2))) +
  theme_void()

# Micx Prediction Map

PredData <- PredData |>
  arrange(pred_micx_fit) |>
  mutate(disc_micx = case_when(pred_micx_fit < 0.25 ~ "M1",
                               pred_micx_fit >= 0.25 & pred_micx_fit < 0.50 ~ "M2",
                               pred_micx_fit >= 0.50 & pred_micx_fit < 0.75 ~ "M3",
                               pred_micx_fit >= 0.75 ~ "M4"),
         disc_micx = factor(disc_micx, levels = c("M1", "M2", "M3", "M4")))

labels = c("≥ 0 - 25", "≥ 25 - 50", "≥ 50 - 75", "≥ 75 - 100")
breaks <- c(0.25,0.50,0.75,1.0)
micx_colors <- c("#2980b9","#aed6f1","#f0b27a","#d35405")

micx_pred_map <- ggplot(PredData, aes(color = disc_micx)) +
  geom_sf(size = 0.3) +
  scale_color_manual(values = micx_colors,
                     labels = labels,
                     name = "Probability of \nDetection (%)") +
  geom_sf(data = states, fill = NA, color = "black", lwd = 0.1) +
  guides(color = guide_legend(override.aes = list(size = 2))) +
  theme_void()

ggarrange(plotlist = list(cyano_pred_map, micx_pred_map), ncol = 1, nrow = 2, labels = "auto", align = "h")

```

The farm and developed nutrient inputs included in the models were lower in the West and Eastern Highland ecoregions, while much of the Plains and Lowland ecoregion had higher inputs (@fig-nut-input-map). The majority of the cyanoHABs predictions (62.8% for cyanobacteria, 66.2% for microcystin) were consistent with expectations based on nutrient inputs included in the model, meaning that both cyanoHABs predictions and nutrient inputs were in the same cutoff category (Table 3). Lakes with either lower nutrient inputs and high cyanoHABs risk or higher nutrient inputs and low cyanoHABs risk accounted for 37.2% of cyanobacteria predictions and 33.8% of microcystin predictions.   

```{r prep nut and non-nut analysis}

comp_micx <- PredData |>
  dplyr::select(-starts_with("pred_cyano"),
                -starts_with("cyano_transform")) |>
  drop_na(pred_micx_fit) |>
  mutate(
    ws_nut_inputs = ifelse((n_farm_inputs + n_dev_inputs) >= 10 | (p_farm_inputs + p_dev_inputs) >= 4, "HIGH", "LOW"),
    all_pred = factor(case_when(
      ws_nut_inputs == "HIGH" & pred_micx_fit >= 0.50 ~ 'HNHC',
      ws_nut_inputs == "LOW" & pred_micx_fit >= 0.50 ~ 'LNHC',
      ws_nut_inputs == "HIGH" & pred_micx_fit < 0.50 ~ 'HNLC',
      ws_nut_inputs == "LOW" & pred_micx_fit < 0.50 ~ 'LNLC',
      TRUE ~ 'OTHER'),
      levels = c('HNHC','HNLC','LNHC','LNLC'))
    ) |>
    arrange(all_pred)

comp_cyano <- PredData |>
  dplyr::select(-starts_with("pred_micx"),
                -starts_with("micx_transform")) |>
  drop_na(cyano_transform_fit) |>
  mutate(
    ws_nut_inputs = ifelse((n_farm_inputs + n_dev_inputs) >= 10 | (p_farm_inputs + p_dev_inputs) >= 4, "HIGH", "LOW"),
    all_pred = factor(case_when(
      ws_nut_inputs == "HIGH" & pred_cyano_fit >= 5 ~ 'HNHC',
      ws_nut_inputs == "LOW" & pred_cyano_fit >= 5 ~ 'LNHC',
      ws_nut_inputs == "HIGH" & pred_cyano_fit < 5 ~ 'HNLC',
      ws_nut_inputs == "LOW" & pred_cyano_fit < 5 ~ 'LNLC',
      TRUE ~ 'OTHER'),
      levels = c('HNHC','HNLC','LNHC','LNLC'))
    ) |>
    arrange(all_pred)

```

Table 3. The number and percent of lake predictions within each category for annual anthropogenic nutrient inputs and cyanoHABs risk.
```{r table nutrient/cyanoHABs categories}

pred_breakdown <- comp_cyano |>
  st_drop_geometry() |>
  select(all_pred) |>
  mutate(var = "Cyanobacteria") |>
  rbind(st_drop_geometry(mutate(select(comp_micx, all_pred), var = "Microcystin"))) |>
  group_by(var, all_pred) |>
  summarise(count = n(), .groups = "drop") |>
  mutate(pct = paste0(round(count / nrow(PredData) * 100, 1), "%"),
         count = prettyNum(count, big.mark = ",")) |>
         # lake_pct = paste0(pred_count, " (", pct, "%)")) |>
  pivot_wider(names_from = "var", values_from = c("count", "pct")) |>
  mutate(Category = case_when(
    all_pred == "HNHC" ~ "High Nutrient, High CyanoHABs",
    all_pred == "HNLC" ~ "High Nutrient, Low CyanoHABs",
    all_pred == "LNHC" ~ "Low Nutrient, High CyanoHABs",
    all_pred == "LNLC" ~ "Low Nutrient, Low CyanoHABs"),
    .keep = "unused", .before = 1) |>
  arrange(desc(Category)) |>
  relocate(Category,
           count_Cyanobacteria,
           pct_Cyanobacteria,
           count_Microcystin,
           pct_Microcystin)

pred_header <- data.frame(
  col_keys = colnames(pred_breakdown),
  line2 = c("Category", rep("Cyanobacteria", 2), rep("Microcystin", 2)),
  line3 = c("Category", rep(c("Lakes", "Percent"), 2))
  )

pred_nut_table <- pred_breakdown |>
  flextable() |>
  set_header_df(mapping = pred_header, key = "col_keys" ) |>
  merge_v(part = "header", j = c(1:2)) |> 
  merge_h(part = "header", i = 1) |> 
  theme_booktabs(bold_header = TRUE) |>
  theme_box() |>
  align(align = "center", part = "header") |>
  align(align = "right", part = "body") |>
  fontsize(size = 10, part = "body") |>
  fontsize(size = 10, part = "header")

pred_nut_table

```

\pagebreak

The precipitation, baseflow index, and area:depth ratio had significantly different means across the nutrient-cyanoHAB categories for both the cyanobacteria and microcystin models (ANOVA, p<0.001, @fig-density-plots). Across both the cyanobacteria and microcystin models the lower nutrient and high cyanoHAB category had median precipitation notably lower relative to the other three nutrient-cyanoHAB categories. For the microcystin model, the median precipitation for the higher nutrient and low cyanoHAB category was notably higher than either the higher nutrient and high cyanoHAB or the lower nutrient and low cyanoHAB categories. Lakes with higher baseflow relative to stormflow had lower cyanoHABs risk, regardless of nutrient inputs. For the microcystin model in particular, the lower nutrient and high cyanoHAB category had a notably lower baseflow index relative to the three other categories. Lakes with higher area:depth ratio were more likely to have high predicted cyanobacteria in both higher and lower nutrient input watersheds. For the microcystin model in particular, the lower nutrient and high cyanoHAB category had a slightly higher area:depth ratio compared to the three other categories. 

```{r nutrient input comparisons, include = FALSE}

# Tables comparing the different types of nutrient inputs and whether that changes the "high" versus "low" nutrient input designations

th_n <- 10
th_p <- 4

# The current analysis relies on just the nutrient inputs that are included in the respective models. How do the numbers change when all nutrient inputs included in the model are used to determine high/low nutrient inputs? What about when deposition is included as well?
habs |>
  st_drop_geometry() |>
  distinct(UNIQUE_ID, .keep_all = TRUE) |>
  mutate(th_n_farm = ifelse(n_farm_inputs >= th_n, "HIGH", "LOW"),
         th_p_farm = ifelse(p_farm_inputs >= th_p, "HIGH", "LOW"),
         th_n_dev = ifelse(n_dev_inputs >= th_n, "HIGH", "LOW"),
         th_p_dev = ifelse(p_dev_inputs >= th_p, "HIGH", "LOW"),
         ) |>
  mutate(cyano_model_inputs = ifelse(th_n_farm == "HIGH" | th_p_dev == "HIGH", "HIGH", "LOW"),
         micx_model_inputs = ifelse(th_n_dev == "HIGH" | th_p_farm == "HIGH", "HIGH", "LOW"),
         all_model_inputs = ifelse((n_farm_inputs + n_dev_inputs) >= th_n | 
                                   (p_farm_inputs + p_dev_inputs) >= th_p, "HIGH", "LOW")
         ) |>
  mutate(tot_n_inputs = N_Fert_Farm + N_livestock_Waste + N_Total_Deposition + N_Fert_Urban + N_Human_Waste + N_CBNF,
         tot_p_inputs = P_f_fertilizer + P_livestock_Waste + P_Deposition + P_nf_fertilizer + P_human_waste_kg,
         all_nni_inputs = ifelse(tot_n_inputs >= th_n | tot_p_inputs >= th_p, "HIGH", "LOW")
         ) |>
  pivot_longer(cols = c(cyano_model_inputs:all_model_inputs, all_nni_inputs), 
               values_to = "inputs", names_to = "input_scope") |>
  group_by(input_scope, inputs) |>
  summarize(count = n(), .groups = "drop") |>
  drop_na() |>
  mutate(includes = c(rep("N/P Farm Fert, N/P Manure, N/P Human Waste, N/P Dev Fert, N CBNF, NO DEPOSITION", 2),
                   rep("N/P Farm Fert, N/P Manure, N/P Human Waste, N/P Dev Fert, N/P Dep, N CBNF, INCLUDES DEPOSITION", 2),
                   rep("N Farm Fert, N Manure, N CBNF, P Dev Fert, P Human Waste", 2),
                   rep("P Farm Fert, P Manure, N Human Waste, N Dev Fert", 2))) |>
  mutate(input_scope = factor(input_scope, levels = c("cyano_model_inputs",
                                                      "micx_model_inputs",
                                                      "all_model_inputs",
                                                      "all_nni_inputs"))) |>
  arrange(input_scope) |>
  flextable() |>
  merge_v(part = "body", j = c(1, 4)) |>
  theme_box() |>
  width(j = 4, width = 3)

```


```{r density plots - precip, message = FALSE}
#| label: fig-density-plots
#| fig-width: 5
#| fig-height: 9
#| fig-cap: "Density distributions of mean annual precipitation (a), baseflow index (b), and lake area:depth ratio (c) for the four nutrient input and cyanoHAB risk categories for the predictions from the cyanobacteria abundance (first column) and probability of microcystin detection (second column). Vertical bars in distributions represent the median. Precipitation and the area:depth ratio distributions are truncated to better show majority of data density and differences in medians."

den_df <- comp_cyano |>
  st_drop_geometry() |>
  select(BFIWs, ad_ratio, Precip8110Ws, all_pred) |>
  mutate(resp = "Cyanobacteria") |>
  rbind(mutate(select(st_drop_geometry(comp_micx),
                      BFIWs, ad_ratio, Precip8110Ws, all_pred),
               resp = "Microcystin")) |>
  # Removing infinite values (when depth = 0)
  mutate(ad_ratio = ifelse(is.infinite(ad_ratio), NA, ad_ratio)) |> 
  tibble()

cat_labels <- c('High Nutrient, High CyanoHABs',
                'High Nutrient, Low CyanoHABs',
                'Low Nutrient, High CyanoHABs',
                'Low Nutrient, Low CyanoHABs')

precip_den <- ggplot(den_df) +
  ggridges::geom_density_ridges(aes(x = Precip8110Ws, y = all_pred, fill = all_pred),
                                na.rm = TRUE,
                                scale = 2,
                                alpha = 0.85,
                                quantile_lines = TRUE, quantiles = 2) +
  facet_wrap(~ resp) +
  scale_fill_manual(values = c("#9c0082","#cc6de4","#4e8562", "#8bd1a5"),
                    labels = cat_labels) +
  xlim(0, 2000) +
  labs(x = "Precipitation (mm)") +
  theme(axis.title.y = element_blank(),
        legend.title = element_blank()) 

bfi_den <- ggplot(den_df) +
  ggridges::geom_density_ridges(aes(x = BFIWs, y = all_pred, fill = all_pred),
                                na.rm = TRUE,
                                scale = 2,
                                alpha = 0.85,
                                quantile_lines = TRUE, quantiles = 2) +
  facet_wrap(~ resp) +
  scale_fill_manual(values = c("#9c0082","#cc6de4","#4e8562", "#8bd1a5"),
                    labels = cat_labels) +
  xlim(0, 100) +
  labs(x = "Baseflow Index (%)") +
  theme(axis.title.y = element_blank(),
        legend.title = element_blank()) 

ad_den <- ggplot(den_df) +
  ggridges::geom_density_ridges(aes(x = ad_ratio, y = all_pred, fill = all_pred),
                                na.rm = TRUE,
                                scale = 2,
                                alpha = 0.85,
                                quantile_lines = TRUE, quantiles = 2) +
  facet_wrap(~ resp) +
  scale_fill_manual(values = c("#9c0082","#cc6de4","#4e8562", "#8bd1a5"),
                    labels = cat_labels) +
  xlim(0, 0.5) +
  labs(x = "Area:Depth Ratio") +
  theme(axis.title.y = element_blank(),
        legend.title = element_blank(),
        legend.position = "bottom") +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE))


ggpubr::ggarrange(precip_den, bfi_den, ad_den,
                  ncol = 1, nrow = 3,
                  common.legend = TRUE, 
                  legend.grob = get_legend(ad_den),
                  legend = "bottom",
                  labels = "auto")
```

```{r ANOVA}

# building model for spatial analysis

# cyanos

# Deal with infinite area depth ratios from zero depth values. Reset these depths to instead be a very small number.
comp_cyano <- comp_cyano |>
  mutate(ad_ratio = ifelse(MAXDEPTH == 0, 0.0001, MAXDEPTH))

bf_model <- splm(BFIWs ~ all_pred, comp_cyano, spcov_type = "exponential")
anova(bf_model)

ad_model <- splm(log10(ad_ratio) ~ all_pred, comp_cyano, spcov_type = "exponential")
anova(ad_model)

precip <- splm(log10(Precip8110Ws) ~ all_pred, comp_cyano, spcov_type = "exponential")
anova(precip)

# micx
comp_micx <- comp_micx |>
  mutate(ad_ratio = ifelse(MAXDEPTH == 0, 0.0001, MAXDEPTH))

bfm_model <- splm(BFIWs ~ all_pred, comp_micx, spcov_type = "exponential")
anova(bfm_model)

adm_model <- splm(log10(ad_ratio) ~ all_pred, comp_micx, spcov_type = "exponential")
anova(adm_model)

precipm <- splm(log10(Precip8110Ws) ~ all_pred, comp_micx, spcov_type = "exponential")
anova(precipm)

```


\pagebreak

## Supplemental Material

#### Contents
* Tables S1-S8
* Figures S1-S4
** @fig-covar-contri
** @fig-std-resid-maps
** @fig-resid-maps-inlake
** @fig-nut-input-map

Table S1. Summary statistics for response variable and covariates explored in model selection.
```{r variable summary table}
# Each variable that was considered in the modeling process
# Note that some of these values were excluded from the model development process because of suspected unreasonable outliers. Will need to update this once I determine where in the pipeline to trim these data.

summerizer <- function(var){
  colnum <- match(var[1], colnames(habs))
  dat    <- pull(habs, colnum)
  tibble(Variable = var[2],
         Units = var[3],
         Min = min(dat, na.rm = TRUE),
         Med = median(dat, na.rm = TRUE),
         Mean = mean(dat, na.rm = TRUE),
         Max = max(dat, na.rm = TRUE),
         Scale = var[4],
         Source = var[5]
         )
}

vec_list <- list(
  c("B_G_DENS", "Cyanobacteria", "cells/mL", "Lake", "NLA"),
  c("MICX", "Microcystin", "ug/L", "Lake", "NLA"),
  c("PTL", "Total Phosphorus", "ug/L", "Lake", "NLA"),
  c("NTL", "Total Nitrogen", "mg N/L", "Lake", "NLA"),
  c("NITRATE_N", "Nitrate", "mg N/L", "Lake", "NLA"),
  c("AMMONIA_N", "Ammonium", "mg N/L", "Lake", "NLA"),
  c("DOC", "Dissolved Organic Carbon", "mg/L", "Lake", "NLA"),
  c("PH", "pH", "Std. Units", "Lake", "NLA"),
  c("TURB", "Tubidty", "NTU", "Lake", "NLA"),
  c("EVAP_INFL", "Evaporation:Inflow", "unitless", "Lake", "NLA"),
  c("MAXDEPTH", "Maximum Lake Depth", "meters", "Lake", "NLA"),
  c("lakemorpho_fetch", "Lake Fetch", "meters", "Lake", "Lakemorpho"),
  c("N_Fert_Farm", "Farm Fertilizer N", "kg/ha/yr", "Watershed", "National Nutrient Inventory"),
  c("N_livestock_Waste", "Livestock Waste N", "kg/ha/yr", "Watershed", "National Nutrient Inventory"),
  c("N_CBNF", "Cultivated Crop Biological Nitrogen Fixation", "kg/ha/yr", "Watershed", "National Nutrient Inventory"),
  c("P_f_fertilizer", "Farm Fertilizer P", "kg/ha/yr", "Watershed", "National Nutrient Inventory"),
  c("P_livestock_Waste", "Livestock Waste P", "kg/ha/yr", "Watershed", "National Nutrient Inventory"),
  c("N_Human_Waste", "Human Waste N", "kg/ha/yr", "Watershed", "National Nutrient Inventory"),
  c("N_Fert_Urban", "Non-Farm Fertilizer N", "kg/ha/yr", "Watershed", "National Nutrient Inventory"),
  c("P_human_waste_kg", "Human Waste P", "kg/ha/yr", "Watershed", "National Nutrient Inventory"),
  c("P_nf_fertilizer", "Non-Farm Fertilizer P", "kg/ha/yr", "Watershed", "National Nutrient Inventory"),
  c("n_farm_inputs", "Total Farm N Inputs", "kg/ha/yr", "Watershed", "National Nutrient Inventory"),
   c("p_farm_inputs", "Total Farm P Inputs", "kg/ha/yr", "Watershed", "National Nutrient Inventory"),
   c("n_dev_inputs", "Total Developed N Inputs", "kg/ha/yr", "Watershed", "National Nutrient Inventory"),
   c("p_dev_inputs", "Total Developed P Inputs", "kg/ha/yr", "Watershed", "National Nutrient Inventory"),
  c("fst_ws", "Forested Land Cover", "percent", "Watershed", "NLCD 2011"),
  c("BFIWs", "Baseflow Index", "unitless", "Watershed", "LakeCat"),
  c("precip_mean_month", "Month Mean Precipitation", "millimeters", "Watershed", "LakeCat"),
  c("temp_mean_month", "Month Mean Temperature", "degC", "Watershed", "LakeCat"),
  c("Precip8110Ws", "Mean Annual Precipitation", "millimeters", "Watershed", "LakeCat"),
  c("Tmean8110Ws", "Mean Annual Temperature", "millimeters", "Watershed", "LakeCat")
)

summary_covariate_table <- do.call(rbind, lapply(vec_list, summerizer)) |>
  mutate(Type = c(rep("In-Lake Conditions", 10), 
                  rep("Lake Geometry", 2), 
                  rep("Nutrient Inputs", 14), 
                  rep("Geographic Setting", 5)), .before = "Variable")

options(digits = 1)
covar_sum_table <- summary_covariate_table |>
  flextable() |>
  colformat_num(j = c("Min","Med","Mean","Max"), digits = 2, part = "body") |>
  merge_v(part = "body", j = 1) |> 
  theme_booktabs(bold_header = TRUE) |>
  theme_box() |>
  align(align = "center", part = "header") |>
  align(align = "center", j = 1, part = "body") |>
  fontsize(size = 10, part = "body") |>
  fontsize(size = 10, part = "header")

covar_sum_table

```

```{r model selection tables}

# Create a table of model comparison process
tabs <- c("cyano_mod_compare_withlakedata.rds",
          "cyano_mod_compare_nolakedata.rds",
          "micx_iemod_compare_withlakedata.rds",
          "micx_iemod_compare_nolakedata.rds",
          "micx_spmod_compare_withlakedata.rds",
          "micx_spmod_compare_nolakedata.rds")

# Vector of strings to replace with covariate names
covar_labs <-  c("NTL" = "Total N",
                 "PTL" = "Total P",
                 "NITRATE_N" = "Nitrate",
                 "AMMONIA_N" = "Ammonium",
                 "DOC" = "DOC",
                 "TURB" = "Turbidity",
                 "PH" = "pH",
                 "EVAP_INFL" = "Evaporation/Inflow",
                 "MAXDEPTH" = "Lake Depth",
                 "lakemorpho_fetch" = "Lake Fetch",
                 "n_farm_inputs" = "Farm N Inputs",
                 "p_farm_inputs" = "Farm P Inputs",
                 "n_dev_inputs" = "Developed N Inputs",
                 "p_dev_inputs" = "Developed P Inputs",
                 "fst_ws" = "Forest Cover",
                 "BFIWs" = "Baseflow Index",
                 "Precip8110Ws" = "Annual Precip",
                 "Tmean8110Ws" = "Annual Air Temp",
                 "precip_mean_month" = "Monthly Precip",
                 "temp_mean_month" = "Monthly Air Temp",
                 "AG_ECO3PLNLOW" = "Ecoregion",
                 "AG_ECO3EHIGH" = "Ecoregion",
                 ":" = " * ")

# A few expressions end up being repeated when there are interactions with ecoregion
# rep_expr <- c("Total N * Ecoregion", "Farm N Inputs * Ecoregion", "Farm P Inputs * Ecoregion")

# The columns to be displayed from each table
cyano_cols   <- c("BIC", "bias", "RMSPE", "cor2")
micx_ie_cols <- c("BIC", "bias", "RMSPE", "AUC")
micx_sp_cols <- c("bias", "RMSPE", "AUC")

cyano_labs   <- c("BIC", "Bias", "RMSPE", "R^2")
micx_ie_labs <- c("BIC", "Bias", "RMSPE", "AUC")
micx_sp_labs <- c("Bias", "RMSPE", "AUC")

# Construct the tables
options(digits = 2)
mod_comp_tabs <- lapply(tabs, function(tab){

  # Columns to display in the table
  cols_sel <- if(grepl("cyano", tab)){list(cyano_cols, cyano_labs)
  } else if(grepl("micx_ie", tab)) {list(micx_ie_cols, micx_ie_labs)
  } else {list(micx_sp_cols, micx_sp_labs)}
  
  # Read in table and format
  dat <- readRDS(paste0(here(), "./inst/model_objects/", tab)) |>
    # Insert breaks so that variables are stacked vertically
    mutate(distinct_vars = gsub(", ", " \n", distinct_vars),
           common_vars = gsub(", ", " \n", common_vars),
           # Maps variable strings to the desired labels
           distinct_vars = str_replace_all(distinct_vars, covar_labs),
           common_vars = str_replace_all(common_vars, covar_labs),
           # Removes duplicated labels using regular expressions (note, this does not capture expressions that have an *)
           distinct_vars = str_replace_all(distinct_vars, "\\b(\\w+)\\s+\\1\\b", "\\1"),
           common_vars = str_replace_all(common_vars, "\\b(\\w+)\\s+\\1\\b", "\\1"))|>
    arrange(model) |>
    select(common_vars, distinct_vars, all_of(cols_sel[[1]]))
  
  # Set the header
  dat_header <- data.frame(
    col_keys = colnames(dat),
    line2 = c(rep("Model Fixed Effects", 2), cols_sel[[2]]),
    line3 = c("Common Set", "Test Set", cols_sel[[2]])
  )
  
  # Table caption builder
  inlake <- ifelse(grepl("nolakedata", tab), "absent", "present")
  error  <- ifelse(grepl("iemod", tab), "independent", "spatial")
  resp   <- ifelse(grepl("cyano", tab), "cyanobacteria", "microcystin")
  cap    <- paste("Model selection for the", resp, "model with in-lake conditions", inlake, "and a", error, "error structure. Fixed effects that are common to all candidate models are listed under Common Set and those that are unique to the model are listed under Test Set.")
  
  # Format the table
  flex_dat <- dat |>
    flextable() |>
    set_header_df(mapping = dat_header, key = "col_keys" ) |>
    merge_v(part = "header", j = c(3:length(dat))) |> 
    merge_h(part = "header", i = 1) |>
    merge_v(part = "body", j = 1) |>
    theme_booktabs(bold_header = TRUE) |>
    fontsize(size = 10, part = "body") |>
    fontsize(size = 10, part = "header") |>
    theme_box() |>
    align(align = "center", part = "header") |>
    autofit(add_w = 0, add_h = 0) |>
    paginate(init = TRUE, hdr_ftr = TRUE)
  
    return(list(cap, flex_dat))
})


```

\pagebreak

Table S2. `r mod_comp_tabs[[1]][[1]]` `r mod_comp_tabs[[1]][[2]]`

\pagebreak

Table S3. `r mod_comp_tabs[[2]][[1]]` `r mod_comp_tabs[[2]][[2]]`

\pagebreak

Table S4. `r mod_comp_tabs[[3]][[1]]` `r mod_comp_tabs[[3]][[2]]`

\pagebreak

Table S5. `r mod_comp_tabs[[5]][[1]]` `r mod_comp_tabs[[5]][[2]]`

\pagebreak

Table S6. `r mod_comp_tabs[[4]][[1]]` `r mod_comp_tabs[[4]][[2]]`

\pagebreak

Table S7. `r mod_comp_tabs[[6]][[1]]` `r mod_comp_tabs[[6]][[2]]`

\pagebreak

Table S8. Final model fixed effect coefficient estimates and standard errors with p-values (ns \>0.05, \* \<0.05, \*\* \<0.01, \*\*\*\* \< 0.001) for cyanobacteria (Cyano) and microcystin (Micx) models. Models where in-lake data were present or absent are included. Grey cells are covariates that were excluded from model development. Empty cells are covariates that were not included in the finla model. Brighter colors denote a lower p-value for either positive (pink) or negative (blue) relationships. Note the scale and range of the covariates in Table S1.
```{r covariate table with coefficient values}

# Table is identical to covariate table in main text, but included the coefficient mean and standard error.

est_and_sign <- fixed_df |>
  filter(!fixed_effect == "(Intercept)") |>
  mutate(est_stderr = paste(signif(estimate, 3), "±", signif(Std_Error, 3)),
         sig = case_when(p >= 0.05 ~ "(ns)",
                         p < 0.05 & p >= 0.01 ~ "*",
                         p < 0.01 & p >= 0.001 ~ "**",
                         p < 0.001 ~ "***"),
         est_sig = paste0(est_stderr, sig),
         fixed_effect = factor(fixed_effect, 
                               levels = c("NTL",
                                          "NITRATE_N",
                                          "AMMONIA_N",
                                          "DOC",
                                          "TURB",
                                          "PH",
                                          "EVAP_INFL",
                                          "n_farm_inputs",
                                          "p_farm_inputs",
                                          "n_dev_inputs",
                                          "p_dev_inputs",
                                          "fst_ws",
                                          "MAXDEPTH",
                                          "lakemorpho_fetch",
                                          "BFIWs",
                                          "Precip8110Ws",
                                          "Tmean8110Ws",
                                          "AG_ECO3PLNLOW",
                                          "AG_ECO3EHIGH",
                                          "NTL:AG_ECO3PLNLOW",
                                          "NTL:AG_ECO3EHIGH"))
         ) |>
  select(response_var:fixed_effect, est_sig) |>
  pivot_wider(names_from = response_var:lake_data,
              values_from = est_sig,
              values_fill = "") |>
  arrange(fixed_effect) |>
  relocate(fixed_effect, cyano_present, micx_present, cyano_absent, micx_absent) |>
  mutate(fixed_effect = c("Total N",
                       "Nitrate",
                       "Ammonium",
                       "DOC",
                       "Turbidity",
                       "pH",
                       "Evaporation/Inflow",
                       "Farm N Inputs",
                       "Farm P Inputs",
                       "Developed N Inputs",
                       "Developed P Inputs",
                       "Forest Cover",
                       "Lake Depth",
                       "Lake Fetch",
                       "Baseflow Index",
                       "Annual Precip",
                       "Annual Air Temp",
                       "Ecoregion PLNLOW",
                       "Ecoregion EHIGH",
                       "Total N * PLNLOW",
                       "Total N * EHIGH"),
         Type = c(rep("In-Lake Conditions", 7),
                  rep("Nutrient Inputs", 5),
                  rep("Lake Geometry", 2),
                  rep("Geographic Setting", 5),
                  rep("Interactions", 2)), .before = fixed_effect
            ) |>
  rename(Covariates = fixed_effect)

colorer_eststderr <- function(i){
  hex <- case_when(grepl("-", i) & grepl("\\*{3}", i) ~ pal[1],
                   grepl("-", i) & grepl("\\*{2}", i) ~  pal[2],
                   grepl("-", i) & grepl("\\*{1}", i) ~   pal[3],
                   grepl("-", i) & grepl("(ns)", i) ~  pal[4],
                   i == "" ~        pal[5],
                   !grepl("-", i) & grepl("(ns)", i) ~  pal[6],
                   !grepl("-", i) & grepl("\\*{1}", i) ~   pal[7],
                   !grepl("-", i) & grepl("\\*{2}", i) ~  pal[8],
                   !grepl("-", i) & grepl("\\*{3}", i) ~ pal[9])
}

est_header <- data.frame(
  col_keys = colnames(est_and_sign),
  line2 = c(rep("Model", 2), rep("In-Lake Conditions", 4)),
  line3 = c(rep("Model", 2), c(rep("Present", 2), rep("Absent", 2))),
  line4 = c("Type", "Covariates", rep(c("Cyano", "Micx"), 2))
)

covar_tbl <- est_and_sign |>
  flextable() |>
  set_header_df(mapping = est_header, key = "col_keys" ) |>
  merge_v(part = "header", j = c(1:2)) |> 
  merge_v(part = "body", j = 1) |> 
  merge_h(part = "header", i = c(1:2)) |> 
  theme_booktabs(bold_header = TRUE) |>
  bg(bg = colorer_eststderr,
     j = 3:6, # All columns in the body except for the first one
     part = "body") |>
  bg(j = c(5:6), i = c(1:7), bg = "#606060") |> # Covariates that weren't available to the models
  theme_box() |>
  align(align = "center", part = "header") |>
  fontsize(size = 10, part = "body") |>
  fontsize(size = 10, part = "header")

covar_tbl
```

\pagebreak

```{r figure of covariate contributions}
#| label: fig-covar-contri
#| fig-width: 6
#| fig-height: 8
#| fig-cap: "Covariate contributions (slope * variable value) to the fitted value (x-axis) for each of the observed lakes used to fit the models without in-lake conditions for cyanobacteria abundance (a) and probability of microcystin detection (b). Only continuous variables are included; the model intercept and categorical variables are excluded. Note that the covariate contributions are displayed on a standardized and centered scale and fitted values are on the response scale."

att_cyan <- cov_cyan |>
  mutate(resp = "Cyano") |>
  pivot_longer(c(n_farm_inputs:lakemorpho_fetch, de), names_to = "variable", values_to = "variable_contr") |>
  mutate(variable = factor(variable, levels = c("de",
                                                "Tmean8110Ws",
                                                "Precip8110Ws",
                                                "BFIWs",
                                                "lakemorpho_fetch",
                                                "MAXDEPTH",
                                                "p_dev_inputs",
                                                "n_farm_inputs"))
  ) |>
  arrange(fitted)

att_micx <- cov_micx |>
  mutate(resp = "Micx") |>
  pivot_longer(c(p_farm_inputs:BFIWs, de), names_to = "variable", values_to = "variable_contr") |>
  mutate(variable = factor(variable, levels = c("de",
                                                "Tmean8110Ws",
                                                "Precip8110Ws",
                                                "BFIWs",
                                                "lakemorpho_fetch",
                                                "MAXDEPTH",
                                                "fst_ws",
                                                "n_dev_inputs",
                                                "p_farm_inputs"))
  ) |>
  arrange(fitted)

cyan_attri_plot <- ggplot(att_cyan, aes(x = variable, y = variable_contr, color = fitted)) +
  geom_quasirandom(shape = 16, size = 0.75, groupOnX = TRUE) +
  scale_color_gradientn(colors = c("#21618C","#5499C7","#A9CCE3","#EDBB99","#DC7633","#A04000"),
                        name = "Fitted \nCyanobacteria \nAbundance \n(cell/mL)",
                        breaks = c(log10(3000+1000), log10(10000+1000), log10(30000+1000), log10(100000+1000)),
                        labels = c("3,000", "10,000", "30,000", "100,000")) +
  scale_x_discrete(labels = c("n_farm_inputs" = "Farm N Inputs", 
                              "p_dev_inputs" = "Developed P Inputs", 
                              "MAXDEPTH" = "Lake Depth",
                              "lakemorpho_fetch" = "Lake Fetch",
                              "BFIWs" = "Baseflow Index",
                              "Precip8110Ws" = "Annual Precip",
                              "Tmean8110Ws" = "Annual Temp",
                              "de" = "Spatial Residual"),
                   name = "") +
  coord_flip() +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank())

micx_attri_plot <- ggplot(att_micx, aes(x = variable, y = variable_contr, color = fitted)) +
  geom_quasirandom(shape = 16, size = 0.75, groupOnX = TRUE) +
  scale_color_gradientn(colors = c("#2980b9","#aed6f1","#f0b27a","#d35405"),
                        name = "Probability \nMicrocystin \nDetection \n(%)") +
  scale_x_discrete(labels = c("p_farm_inputs" = "Farm P Inputs", 
                              "n_dev_inputs" = "Developed N Inputs", 
                              "fst_ws" = "Forest Cover",
                              "MAXDEPTH" = "Lake Depth",
                              "lakemorpho_fetch" = "Lake Fetch",
                              "BFIWs" = "Baseflow Index",
                              "Precip8110Ws" = "Annual Precip",
                              "Tmean8110Ws" = "Annual Temp",
                              "de" = "Spatial Residual")) +
  coord_flip() +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank())

attr_fig <- ggarrange(plotlist = list(cyan_attri_plot, micx_attri_plot), ncol = 1, nrow = 2, labels = "auto")

attr_fig <- annotate_figure(attr_fig, bottom = "Covariate Contribution to Fitted Value (standardized)")

attr_fig

```

```{r standarized residual maps}
#| label: fig-std-resid-maps
#| fig-width: 9
#| fig-height: 6.5
#| fig-cap: "Standardized residuals for the models with in-lake conditions present (top row) for cyanobacteria abundance (a) and probability of microcystin detection (b) and models with in-lake conditions absent (bottom row) for cyanobacteria abundance (c) and probability of microcystin detection (d)."

# Augment the splm objects to add the standardized residuals
resp    <- rep(c("Cyanobacteria", "Microcystin"), 2)
in_lake <- c(rep("Present", 2), rep("Absent", 2))

auged_splms <- lapply(list(cyano_lake, micx_lake, cyano_nolake, micx_nolake), augment)

stresids <- lapply(seq_along(auged_splms), function(i){
  auged_splms[[i]] |>
    mutate(resp = resp[i],
           in_lake = in_lake[i]) |>
    select(resp, in_lake, .std.resid) |>
    st_transform(cyano_nolake$crs) |>
    mutate(rank = case_when(.std.resid > 4 ~ 4,
                            .std.resid > 3 & .std.resid < 4 ~ 3,
                            .std.resid < -2 ~ 2,
                            TRUE ~ 1)) |>
    arrange(rank)
})

stresid_maps <- lapply(seq_along(stresids), function(i){
  ggplot() + 
    geom_sf(data = conus, fill = "#e2e2e2", color = "white", lwd = 1) +
    geom_sf(data = stresids[[i]], 
            aes(fill = .std.resid), pch = 21, size = 1.5) +
    colorspace::scale_fill_continuous_divergingx(palette = "BrBG", 
                                                 mid = 0, 
                                                 name = "Standardized\nResidual") +
    # ggtitle(paste(resp[i], in_lake[i])) +
    theme_void()
})

ggarrange(plotlist = stresid_maps, ncol = 2, nrow = 2, labels = "auto")

```


```{r spatial residulas maps for in-lake models}
#| label: fig-resid-maps-inlake
#| fig-width: 6
#| fig-height: 7
#| fig-cap: "Spatial residuals for the cyanobacteria abundance (a) and probability of microcystin detection (b) models with in-lake conditions present."

cyano_lake_aug <- augment(cyano_lake) |>
  mutate(spde = fitted(cyano_lake, type = "spcov")$de,
         resp = "Cyanobacteria") |>
  select(resp, spde)

micx_lake_aug <- augment(micx_lake) |>
  mutate(spde = fitted(micx_lake, type = "spcov")$de,
         resp = "Microcystin") |>
  select(resp, spde) |>
  st_transform(st_crs(cyano_lake_aug))
  
spde <- rbind(cyano_lake_aug, micx_lake_aug)

cyan_lake_spde_map <- ggplot() + 
  geom_sf(data = conus, fill = "#e2e2e2", color = "white", lwd = 1) +
  geom_sf(data = cyano_lake_aug, 
          aes(fill = spde), pch = 21, size = 1.5) +
  colorspace::scale_fill_continuous_divergingx(palette = "BrBG", 
                                               mid = 0, 
                                               name = "Spatial\nResiduals") +
    theme_void()

micx_lake_spde_map <- ggplot() + 
  geom_sf(data = conus, fill = "#e2e2e2", color = "white", lwd = 1) +
  geom_sf(data = micx_lake_aug, 
          aes(fill = spde), pch = 21, size = 1.5) +
  colorspace::scale_fill_continuous_divergingx(palette = "BrBG", 
                                               mid = 0, 
                                               name = "Spatial\nResiduals") +
    theme_void()

ggarrange(plotlist = list(cyan_lake_spde_map, micx_lake_spde_map), ncol = 1, nrow = 2, labels = "auto")

```


```{r high and low nutrient watersheds}
#| label: fig-nut-input-map
#| fig-width: 6
#| fig-height: 4
#| fig-cap: "Annual anthropogenic nitrogen and phosphorus inputs to the 124,529 lake watersheds for which predictions of cyanoHABs were generated. Inputs consist of the sum of farm fertilizer, manure, developed landscape fertilizer, and human waste for each nutrient. Nitrogen has an additional term for cultivated crop biological nitrogen fixtation. High nutrient inputs consist of at least 10 kg N/ha/yr or 4 kg P/ha/yr inputs."

nut_inputs <- PredData |>
  mutate(ws_nut_inputs = ifelse((n_farm_inputs + n_dev_inputs) >= 10 | 
                                (p_farm_inputs + p_dev_inputs) >= 4, "HIGH", "LOW"),
         ws_nut_inputs = factor(ws_nut_inputs, levels = c("LOW", "HIGH"))) |>
  drop_na(ws_nut_inputs) |>
  arrange(ws_nut_inputs)

ggplot(nut_inputs, aes(color = ws_nut_inputs)) +
  geom_sf(size = 0.3) +
  scale_color_manual(values = c("#4e8562", "#9c0082"),
                    labels = c("Low", "High"),
                    name = "Annual \nAnthropogenic \nWatershed \nNutrient \nInputs") +
  geom_sf(data = states, fill = NA, color = "black", lwd = 0.1) +
  guides(color = guide_legend(override.aes = list(size = 2))) +
  theme_void()

```

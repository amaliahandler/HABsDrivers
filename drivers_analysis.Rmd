---
title: "drivers_analysis"
author: "Handler"
date: '2022-11-21'
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(usethis)
library(devtools)
library(spmodel)
library(mapview)
library(dplyr)

# Detailed guide to spmodel
# https://rdrr.io/cran/spmodel/f/inst/doc/guide.pdf
```

Experiment with some spatial models

```{r}
# Load all data and functions from HABsDrivers package
load_all()

# Filter to only include first visits and most recent samples so that we have an independent set of data
# habs_ind <- habs %>%
#   filter(VISIT_NO == 1) %>%
#   group_by(UNIQUE_ID) %>%
#   filter(DSGN_CYCLE == max(DSGN_CYCLE))

# Create some composite variables of land use
habs <- habs %>%
  mutate(urban = case_when(DSGN_CYCLE == 2007 ~ PctUrbOp2006Ws + 
                             PctUrbLo2006Ws + PctUrbMd2006Ws + PctUrbHi2006Ws,
                           TRUE ~ PctUrbOp2011Ws + PctUrbLo2011Ws + 
                             PctUrbMd2011Ws + PctUrbHi2011Ws),
         wetland = case_when(DSGN_CYCLE == 2007 ~ PctWdWet2006Ws + PctHbWet2006Ws,
                            TRUE ~ PctWdWet2011Ws + PctHbWet2011Ws),
         forest = case_when(DSGN_CYCLE == 2007 ~ PctDecid2006Ws + PctConif2006Ws + PctMxFst2006Ws,
                            TRUE ~ PctDecid2011Ws + PctConif2011Ws + PctMxFst2011Ws),
         agriculture = case_when(DSGN_CYCLE == 2007 ~ PctHay2006Ws + PctCrop2006Ws,
                                 TRUE ~ PctHay2011Ws + PctCrop2011Ws))

# Run a few different versions of the model

# Just in-lake data (NARS only) to compare spatial covariance types
mod_lake_exp <- splm(log10(B_G_DENS + 1) ~ NTL + PTL + DOC + TURB + PH + TEMPERATURE, data = habs_ind, spcov_type = "exponential")

mod_lake_sph <- splm(log10(B_G_DENS + 1) ~ NTL + PTL + DOC + TURB + PH + TEMPERATURE, data = habs_ind, spcov_type = "spherical")

mod_lake_gau <- splm(log10(B_G_DENS + 1) ~ NTL + PTL + DOC + TURB + PH + TEMPERATURE, data = habs_ind, spcov_type = "gaussian")

glances(mod_lake_exp, mod_lake_sph, mod_lake_gau)
# Exponential and spherical spatial covariance performs the same according to AIC, gaussian performs worse

# NARS and watershed data
mod_lake_land <- splm(log10(B_G_DENS + 1) ~ NTL + PTL + DOC + TURB + PH + TEMPERATURE + urban + wetland + forest + agriculture, data = habs_ind, spcov_type = "exponential")

glances(mod_lake_exp, mod_lake_land)
# Adding more variables does not substantially increase the variation explained

# Compare with random effects and without random effects

# Random effect for survey year and lake, not nested
mod_re_unnested <- splm(log10(B_G_DENS + 1) ~ NTL + PTL + DOC + TURB + PH + TEMPERATURE + urban + wetland + forest + agriculture + lakemorpho_depth + Precip_Minus_EVTWs + Tmean8110Ws + ElevWs + SlopeWs, data = habs, random = ~ DSGN_CYCLE + UNIQUE_ID, spcov_type = "exponential", local = TRUE) 

# Random effect for survey year and lake nested within survey year (revisits) 
mod_re_nested <- splm(log10(B_G_DENS + 1) ~ NTL + PTL + DOC + TURB + PH + TEMPERATURE + urban + wetland + forest + agriculture + lakemorpho_depth + Precip_Minus_EVTWs + Tmean8110Ws + ElevWs + SlopeWs, data = habs, random = ~ (DSGN_CYCLE / UNIQUE_ID), spcov_type = "exponential", local = TRUE) 

# Compare models
glances(mod_re_unnested, mod_re_nested)
# Nested model has lower AIC than the unnested model

# Check model performance by loocv
loocv(mod_re_unnested, local = T)

re_nested_resid <- augment(mod_re_nested)

mapview(re_nested_resid, zcol = ".std.resid", at = c(-5.4, -2, 2.6), legend = TRUE)

ggplot(data = re_nested_resid, aes(x = .fitted, y = `log10(B_G_DENS + 1)`)) + 
  geom_point() + 
  geom_abline(intercept = 0, slope = 1)

ggplot(data = re_nested_resid, aes(x = .std.resid)) + 
  geom_histogram() + 

summary(mod_re_nested)
summary(mod_re_unnested)

plot(mod_re_nested)
plot(mod_re_unnested)

# Check that the spatial model performs better than a non-spatial model
mod_nonsp <- splm(log10(B_G_DENS + 1) ~ NTL + PTL + DOC + TURB + PH + TEMPERATURE + urban + wetland + forest + agriculture + lakemorpho_depth + Precip_Minus_EVTWs + Tmean8110Ws + ElevWs + SlopeWs, data = habs, random = ~ (DSGN_CYCLE / UNIQUE_ID), spcov_type = "none", local = TRUE) 

# Compare spatial and non-spatial models with nested random effects
glances(mod_nonsp, mod_re_nested)
# Hmmm, the non-spatial model performs just as well (maybe a little better) than the spatial model

# Is it because there are so many independent variables?
basic_spat <- splm(log10(B_G_DENS + 1) ~ NTL, data = habs, random = ~ (DSGN_CYCLE / UNIQUE_ID), spcov_type = "exponential", local = TRUE) 

basic_nonsp <- splm(log10(B_G_DENS + 1) ~ NTL, data = habs, random = ~ (DSGN_CYCLE / UNIQUE_ID), spcov_type = "none", local = TRUE)

glances(basic_nonsp, basic_spat)
# Reducing the number of independent variables doesn't change the answer. The spatial and non-spatial forms of the model perform about the same

# Try a few different spatial convariance types
gaussian <- splm(log10(B_G_DENS + 1) ~ NTL, data = habs, random = ~ (DSGN_CYCLE / UNIQUE_ID), spcov_type = "gaussian", local = TRUE) 

sphere <- splm(log10(B_G_DENS + 1) ~ NTL, data = habs, random = ~ (DSGN_CYCLE / UNIQUE_ID), spcov_type = "spherical", local = TRUE) 

triangular <- splm(log10(B_G_DENS + 1) ~ NTL, data = habs, random = ~ (DSGN_CYCLE / UNIQUE_ID), spcov_type = "triangular", local = TRUE)

circular <- splm(log10(B_G_DENS + 1) ~ NTL, data = habs, random = ~ (DSGN_CYCLE / UNIQUE_ID), spcov_type = "circular", local = TRUE)

cubic <- splm(log10(B_G_DENS + 1) ~ NTL, data = habs, random = ~ (DSGN_CYCLE / UNIQUE_ID), spcov_type = "cubic", local = TRUE)

glances(basic_nonsp, basic_spat, gaussian, sphere, triangular, circular, cubic)
# Conclusion: Exponential and cubic covariance structure perform the same and only slightly better than other form.

summary(mod_re_nested)
summary(mod_re_unnested)

tidy(mod_re_nested)
glance(mod_re_nested)
plot(mod_re_nested)
plot(mod_re_unnested)

```


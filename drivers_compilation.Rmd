---
title: "HAB Drivers Compilation"
author: "Amalia Handler"
date: "1/5/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

Compiling NLA 2007, 2012, and 2017 cyanobacteria data

```{r}
# Function for getting the number of unique values in a column of a df
helper <- function(df, col_name){
  col_num <- match(col_name, colnames(df))
  vec     <- as.vector(df[,col_num])
  length(unique(vec))
}
```


```{r, include = FALSE, warning = FALSE, message = FALSE}
library(devtools)
library(dplyr)
library(ggplot2)
library(scales)
library(ggpubr)
library(tidyr)

# Load 2017 NLA cyanobacteria data
options(stringsAsFactors = FALSE)
chem17  <- read.csv("NLA2017_Nutrient_Chla_MicroData.csv")
site17  <- read.csv("NLA2017_Siteinfo.csv")
cyano17 <- read.csv("NLA2017_ProfileData_Cyano.csv")

# Restructure the cyanobacteria cell density
bgdens17 <- cyano17 %>%
  select(UID, SITE_ID, VISIT_NO, B_G_DENS) %>%
  rename(RESULT = B_G_DENS) %>%
  mutate(RESULT_UNITS = "CELLS/ML") %>%
  mutate(ANALYTE = "CYANO", .after = VISIT_NO)

# Filter for just the toxin and chlorophyll a data from the chemistry
alg17 <- chem17 %>%
  select(UID, SITE_ID, VISIT_NO, ANALYTE, RESULT, RESULT_UNITS) %>%
  filter(ANALYTE %in% c("MICX", "CYLSPER", "CHLA")) %>%
  mutate(RESULT_UNITS = "UG/L")

# Bind together the two dfs
tmp <- rbind(bgdens17, alg17)

# Merge the lake COMID with the habs data
nlahab17 <- right_join(site17[,c("COMID", "SITE_ID", "INDEX_NLA")], tmp, by = "SITE_ID")

# Add the year of the NLA survey and filter for the indexed sites, then remove INDEX_NLA column
nlahab17 <- nlahab17 %>%
  mutate(NLA_YEAR = 2017, .after = UID) %>%
  filter(INDEX_NLA == "Y") %>%
  select(-INDEX_NLA)

# Load the 2007 and 2012 NLA chemistry and chlorophyll data
nla_data <- read.csv('NLA2007-2012_LakeData_forHABs.csv')

# The cyanobacterial and microsystin data
nla_cyano <- read.csv('NLA2007-2012_LakeData_forHABs_cyano.csv')

# The site info to connect to the COMIDs
nla12_site <- read.csv('NLA_Lakes_2012_Site_Info.csv')
nla07_site <- read.csv('NLA_Lakes_2007_Site_Info.csv')

# Merge the NLA cyano data with the other NLA data
cyano0712 <- left_join(nla_data, nla_cyano[,c(1,3,12:26)], by = c('UID', 'VISIT_NO'))

# Associate the NLA data with site data, which includes the COMIDs
nla12 <- merge(cyano0712, nla12_site[,c('SITE_ID','VISIT_NO','COMID2012')], by = c('SITE_ID','VISIT_NO'))

nla07 <- merge(cyano0712, nla07_site[,c('SITE_ID','VISIT_NO','COM_ID')], by = c('SITE_ID','VISIT_NO'))

# Subset for only the indexed samples

# For 2012 survey, COMID 5195160 only has one sample for this site in this survey and is not indexed as the representative sample. To the best of my querying, it is the only sample for this lake.
# Subset all 2012 data for indexed samples and the single sample for COMID 5195160
nla12_ind <- nla12 %>%
  rename(COMID = COMID2012) %>%
  filter(INDEX_NLA == "Y" | COMID == 5195160)

# There are two observations that erroneously have the same COMID, according to the CyAN list of lake names and COMIDs, the ID in question is in VT, not NY. Also, note that in 2007 the indexed for Chl a is always the same as the sample for microcystin.
nla07_ind <- nla07 %>%
  rename(COMID = COM_ID) %>%
  filter(INDXSAMP_MICR == "Y" & !(COMID == "15447630" & PSTL_CODE == "NY"))

# Bind together 2007 and 2012 data
nla0712 <- rbind(nla12_ind, nla07_ind)

# Convert to long-form, add a units column
nlahab0712 <- nla0712 %>%
  select(COMID, SITE_ID, UID, DSGN_CYCLE, VISIT_NO, CHLA_RESULT, MICX_RESULT, B_G_DENS) %>%
  rename(NLA_YEAR = DSGN_CYCLE,
         CHLA = CHLA_RESULT,
         MICX = MICX_RESULT,
         CYANO = B_G_DENS) %>%
  pivot_longer(cols = CHLA:CYANO,
               names_to = "ANALYTE",
               values_to = "RESULT") %>%
  mutate(RESULT_UNITS = case_when(ANALYTE == "CYANO" ~ "CELLS/ML",
                                  TRUE ~ "UG/L"))
  
# Bind together the NLA cyanobacteria data from 2007, 2012, and 2017
nla_cyano <- rbind(nlahab0712, nlahab17)

# Save this data to an RDS file
saveRDS(nla_cyano, "NLA_AllCompiledCyano.rds")


```


Compile water data from NLAs: Nitrogen, phosphorus, temperature, secchi depth, turbidity, DOC, stratification

```{r}
# Load data
c17 <- read.csv("nla2017_waterchem.csv")
c12 <- read.csv("nla2012_waterchem.csv")
c07 <- read.csv("nla2007_waterchem.csv")

# Get the UIDs and COMIDs from the NLA cyanobacteria data
nla_id <- nla_cyano %>%
  select(COMID, SITE_ID, UID, NLA_YEAR, VISIT_NO) %>%
  distinct()

# Desired chem data
chem_vars <- c("NTL", "PTL", "TURB", "DOC", "PH")

# For ordering the columns below
col_order <- c("COMID", "SITE_ID", 'UID', "NLA_YEAR", "VISIT_NO", "ANALYTE", "RESULT", "RESULT_UNITS")

# Isolate the water chem data. Note that there is no pH in the NLA 2007 water chem data
chem17 <- c17 %>%
  select(UID, ANALYTE, RESULT, RESULT_UNITS) %>%
  right_join(nla_id, by = "UID") %>%
  filter(ANALYTE %in% chem_vars) %>%
  relocate(all_of(col_order))

chem12 <- c12 %>%
  select(UID, paste0(chem_vars, "_RESULT")) %>%
  rename_with(~ gsub("_RESULT", '', .x)) %>%
  right_join(nla_id, by = "UID") %>%
  pivot_longer(NTL:PH, names_to = "ANALYTE", values_to = "RESULT") %>%
  mutate(RESULT_UNITS = case_when(ANALYTE == "PH" ~ "STD. UNITS",
                                  ANALYTE == "TURB" ~ "NTL",
                                  ANALYTE == "PTL" ~ "UG/L",
                                  TRUE ~ "MG/L")) %>%
  relocate(all_of(col_order))

chem07 <- c07 %>%
  select(SITE_ID, VISIT_NO, chem_vars[!chem_vars == "PH"]) %>%
  right_join(nla_id, by = c("SITE_ID", "VISIT_NO")) %>%
  mutate(NTL = NTL/1000) %>%
  pivot_longer(NTL:DOC, names_to = "ANALYTE", values_to = "RESULT") %>%
  mutate(RESULT_UNITS = case_when(ANALYTE == "TURB" ~ "NTL",
                                  ANALYTE == "PTL" ~ "UG/L",
                                  TRUE ~ "MG/L")) %>%
  relocate(all_of(col_order))

# Bind together all
nla_chem <- rbind(chem17, chem12, chem07)

# Load profile data
p17 <- read.csv("nla2017_profile.csv")
p12 <- read.csv("nla2012_profile.csv")
p07 <- read.csv("nla2007_profile.csv")

# There are 3 lakes that have no measurements collected
sfc17 <- p17 %>%
  group_by(UID) %>%
  filter(!is.na(TEMPERATURE)) %>%
  filter(DEPTH == min(DEPTH, na.rm = T)) %>%
  filter(row_number() == 1) %>%
  select(UID, TEMPERATURE) %>%
  rename(RESULT = TEMPERATURE) %>%
  right_join(nla_id[nla_id$NLA_YEAR == 2017,], by = "UID") %>%
  drop_na(RESULT) %>%
  mutate(ANALYTE = "TEMP", RESULT_UNITS = "DEGC") %>%
  relocate(all_of(col_order))

# Seems to be 25 lakes with no temperature measurement
sfc12 <- p12 %>%
  group_by(UID) %>%
  filter(!is.na(TEMPERATURE)) %>%
  filter(DEPTH == min(DEPTH, na.rm = T)) %>%
  filter(row_number() == 1) %>%
  select(UID, TEMPERATURE) %>%
  rename(RESULT = TEMPERATURE) %>%
  right_join(nla_id[nla_id$NLA_YEAR == 2012,], by = "UID") %>%
  drop_na(RESULT) %>%
  mutate(ANALYTE = "TEMP", RESULT_UNITS = "DEGC") %>%
  relocate(all_of(col_order))

# Need to extract temperature and pH info from the 2007 NLA
# Temperature
sfc12_temp <- p07 %>%
  group_by(SITE_ID, VISIT_NO) %>%
  filter(!is.na(TEMP_FIELD)) %>%
  filter(DEPTH == min(DEPTH, na.rm = T)) %>%
  filter(row_number() == 1) %>%
  select(SITE_ID, VISIT_NO, TEMP_FIELD) %>%
  rename(RESULT = TEMP_FIELD) %>%
  right_join(nla_id[nla_id$NLA_YEAR == 2007,], by = c("SITE_ID", "VISIT_NO")) %>%
  drop_na(RESULT) %>%
  mutate(ANALYTE = "TEMP", RESULT_UNITS = "DEGC") %>%
  relocate(all_of(col_order))

# pH
sfc12_pH <- p07 %>%
  group_by(SITE_ID, VISIT_NO) %>%
  filter(!is.na(PH_FIELD)) %>%
  filter(DEPTH == min(DEPTH, na.rm = T)) %>%
  filter(row_number() == 1) %>%
  select(SITE_ID, VISIT_NO, PH_FIELD) %>%
  rename(RESULT = PH_FIELD) %>%
  right_join(nla_id[nla_id$NLA_YEAR == 2007,], by = c("SITE_ID", "VISIT_NO")) %>%
  drop_na(RESULT) %>%
  mutate(ANALYTE = "PH", RESULT_UNITS = "STD. UNITS") %>%
  relocate(all_of(col_order))

# Many NA results for 2012
nrow(sfc12[is.na(sfc12$RESULT),])

uid_na <- sfc12$UID[is.na(sfc12$RESULT)]

head(p12[p12$UID %in% uid_na, c('UID', 'DEPTH', 'TEMPERATURE')]) 

# I think the match function is getting tripped up by the NA values in the depth column

```



```{r}


# Load in NLCD 2016 data
nlcd <- read.csv("NLCD2016.csv")

# Join NLCD with NLA HAB data
nla_nlcd <- left_join(nlahab, nlcd[,c(1,7:38)], by = "COMID")

# Save that data in an RDS file
saveRDS(nla_nlcd, "./compiled_nla17_nlcd16.rds")

# Read in saved RDS file
nla_nlcd <- readRDS("./compiled_nla17_nlcd16.rds")
```


```{r, include = FALSE, warning = FALSE}

# Add 1 to cyanobacteria counts so that zero data will appear on log-transformed figures
nla_nlcd <- nla_nlcd %>%
  mutate(RESULT = ifelse(ANALYTE == "B_G_DENS", RESULT + 1, RESULT))

# Make a massive number of graphs
# ggplot(nla_nlcd, aes(y = RESULT, x = PctOw2016Cat)) +
#   geom_point(pch = 21, alpha = 0.5) +
#   facet_wrap(. ~ ANALYTE, scales = "free_y",  ncol = 4) +
#    scale_y_continuous(trans = 'log10',
#                        breaks = trans_breaks("log10", function(x) 10^x),
#                        labels = trans_format("log10", math_format(10^.x)))

# Make function
plot_nla_nlcd <- function(xvar, name){
  ggplot(nla_nlcd, aes(y = RESULT, x = xvar)) +
    geom_point(pch = 19, alpha = 0.5) +
    facet_wrap(. ~ ANALYTE, scales = "free_y",  ncol = 4) +
    xlab(name) +
    scale_y_continuous(trans = 'log10',
                       breaks = trans_breaks("log10", function(x) 10^x),
                       labels = trans_format("log10", math_format(10^.x)))
}

names <- colnames(nla_nlcd[c(8:39)])

nlcd_plots <- lapply(names, function(name){
  # Get col num
  colnum <- match(name, colnames(nla_nlcd))
  
  # Get column data
  x_var <- nla_nlcd[,colnum]
  
  # Make fig
  plot_nla_nlcd(x_var, name)
  
})

```


```{r, echo = FALSE, warning = FALSE, fig.width = 10, fig.height = 2 * length(nlcd_plots)}

ggarrange(plotlist = nlcd_plots, ncol = 1)

```


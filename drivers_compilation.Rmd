---
title: "HAB Drivers Compilation"
author: "Amalia Handler"
date: "1/5/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

Compiling NLA 2007, 2012, and 2017 cyanobacteria data

```{r, include = FALSE, warning = FALSE, message = FALSE}
library(devtools)
library(dplyr)
library(ggplot2)
library(scales)
library(ggpubr)
library(tidyr)
```

List of variables to compile

National lakes assessment (NLA)
* X_Chlorophyll a
* X_Cyanobacteria abundance
* X_Microcystin
* X_Cylindrospermopsin
* X_Total nitrogen
* X_Total phosphorus
* X_Dissolved organic carbon
* X_Turbidity
* X_pH
* X_Water temperature
* Dissolved oxygen
* X_Stratification
* X_HydroAP
* X_Evaporation/Inflow

PRISM
* X_Air temperature
* X_Precipitation

LakeCat
* X_Urban land cover
* X_Agricultural land cover
* X_Forested/natural land cover
* X_Wetland land cover
* Burned area
* X_Slope
* X_Elevation
* X_Wastewater treatment plants
* X_Runoff

Nutrient Inventory
* Nitrogen and phosphorus inputs
* Nitrogen and phosphorus excess

Lakemorpho
* X_Depth
* X_Fetch
* Surface area
* Perimeter

Load NLA data on cyanobacteria and water physiochemical characteristics
These data were compiled by Karen Blocksom


```{r}
# Read in data
# all_nla <- read.csv("NLA2007-2012-2017_LakeData_forHABs_4April2022.csv")

# Updated from Karen to include temperature data whenever a profile was collected
all_nla <- read.csv("NLA2007-2012-2017_LakeData_forHABs_12April2022.csv")

# Read in NLA UNIQUE_ID - NHDPlusV2 COMID crosswalk info from Marc
nla_lakecat <- read.csv("Integrated_NLA-LakeCat_COMID_Crosswalk.csv")

# Crosswalk document that contains the NLA SITE_ID and the NHDPlusV2 COMID
int_nla <- read.csv("NLA_Integrated_Design_Status_20190821.csv")

# Find the distinct UNIQUE_ID and COMIDs for the NLA-Lakecat crosswalk
unique_nla_lakecat <- nla_lakecat %>%
  select(UNIQUE_ID, COMID) %>%
  distinct()

# Define needed columns
nla_comid <- all_nla %>%
  select(SITE_ID, VISIT_NO, UNIQUE_ID, DSGN_CYCLE, DATE_COL, 
         TEMPERATURE, STRATIFIED, AMMONIA_N, DOC, NTL, PTL, TURB, 
         NITRATE_N, PH, CHLA_RESULT, MICX, CYLSPER, B_G_DENS) %>%
  left_join(unique_nla_lakecat, by = "UNIQUE_ID")

# For sites still missing COMIDs, get from the alternate integrated NLA document
unique_nla_int <- int_nla %>%
  select(UNIQUE_ID, COMID) %>%
  distinct()

missing_coms <- nla_comid %>%
  filter(is.na(COMID)) %>%
  select(!COMID) %>%
  left_join(unique_nla_int, by = "UNIQUE_ID")

nla_all_coms <- nla_comid %>%
  filter(is.finite(COMID)) %>%
  bind_rows(missing_coms)

# Pivot from wide to long format
# Problem with some ammonium numbers recorded as "< 0.03", which cannot be coerced to a numeric value. Need to replace these values with something so that the column can be coerced to numeric type.
# Stratified column is a character currently and need to be changed to numeric type to convert to long format
nla_long <- nla_all_coms %>%
  mutate(STRATIFIED = ifelse(STRATIFIED == "Y", 1,0)) %>%
  mutate(AMMONIA_N = as.numeric(replace(AMMONIA_N, AMMONIA_N == "< 0.03", NA))) %>%
  pivot_longer(TEMPERATURE:B_G_DENS, names_to = "ANALYTE", values_to = "RESULT")

# Where PH data was not measured in the lab, retrieve the top-most pH measurement from the profile
ph_profile <- nla_long %>%
  filter(ANALYTE == "PH") %>%
  filter(is.na(RESULT)) %>%
  select(-RESULT) %>%
  left_join(select(all_nla, VISIT_NO:DSGN_CYCLE, PH_FIELD), 
            by = c("UNIQUE_ID", "DSGN_CYCLE", "VISIT_NO")) %>%
  rename(RESULT = PH_FIELD)

# Remove the rows with missing pH data from the lab and add the field data and add the rows with pH data from the profile data
# Remove NA rows for cylindrospermopsin from 2007 and 2012 surveys because this analysis was not run during those years. Want any NA values present in the df to imply that the analysis was run, but result was below the detection limit.
# Add a units columns
nla_long <- nla_long %>%
  filter(!(ANALYTE == "PH" & is.na(RESULT))) %>%
  bind_rows(ph_profile) %>%
  filter(!(ANALYTE == "CYLSPER" & DSGN_CYCLE %in% c(2007, 2012))) %>%
  mutate(UNITS = case_when(ANALYTE == "TEMPERATURE" ~ "DEG_C",
                           ANALYTE == "STRATIFIED" ~ "Y/N_1/0",
                           ANALYTE %in% c("PTL", "MICX", "CYLSPER") ~ "UG/L",
                           ANALYTE == "TURB" ~ "NTU",
                           ANALYTE == "B_G_DENS" ~ "CELLS/ML",
                           ANALYTE == "PH" ~ "STD_UNITS",
                           ANALYTE %in% c("AMMONIA_N", "DOC", "NTL", "NITRATE_N", "CHLA_RESULT") ~ "MG/L"))

# Performing checks for missing data

# Lots of Nitrate data missing. Looks like everything below the reporting limit was listed as 0.005 mg/L in 2007 (RL = 0.02), but in 2012 (RL = 0.02) and 2017 (RL = 0.0025) ND for nitrate is reported as NA. 
nla_long %>%
  filter(ANALYTE == "NITRATE_N" & is.na(RESULT)) %>%
  nrow()

# Extract NLA observation ID information for joining with other data sources
nla_id <- nla_long %>%
  select(SITE_ID:COMID) %>%
  distinct()



```


Add evaporation to inflow ratio data from Emi Fergus and Renee Brooks


```{r}

# Load data
ratio0712 <- read.csv("NLA2007-2012_E-I_HYDRAP.csv")
ratio17   <- read.csv("NLA17_EI_estimates-Final.csv")

# Transform data to long form
ei0712 <- ratio0712 %>%
  select(SITE_ID, VISIT_NO, YEAR, E_I) %>%
  rename(DSGN_CYCLE = YEAR) %>%
  left_join(nla_id, by = c("SITE_ID", "VISIT_NO", "DSGN_CYCLE")) %>%
  rename(RESULT = E_I) %>%
  mutate(UNITS = "RATIO",
         ANALYTE = "EVAP_INFL")

ei17 <- ratio17 %>%
  select(SITE_ID, E_I, VISIT_NO) %>%
  mutate(DSGN_CYCLE = 2017) %>%
  left_join(nla_id, by = c("SITE_ID", "VISIT_NO", "DSGN_CYCLE")) %>%
  rename(RESULT = E_I) %>%
  mutate(UNITS = "RATIO",
         ANALYTE = "EVAP_INFL")
  
# Bind together 2007/2012 with 2017 data
evap_infl <- rbind(ei0712, ei17)

# Rearrange columns
evap_infl <- relocate(evap_infl, SITE_ID, VISIT_NO, UNIQUE_ID, DSGN_CYCLE, DATE_COL, COMID, ANALYTE, RESULT, UNITS)

# From Emi and Renee: NA values mean that E/I was not calculated for some reason. Generally missing data or unrealistic E/I values were removed
# # Investigating missing values
# filter(ratio0712, is.na(E_I))
# filter(ratio17, is.na(E_I))
#
# write.csv(filter(ratio0712, is.na(E_I)), "missing2012-E_I.csv", row.names = F)
# write.csv(filter(ratio17, is.na(E_I)), "missing2017-E_I.csv", row.names = F)
# 
# filter(ei0712, is.na(COMID))
# filter(ei17, is.na(COMID))

# How many of the NLA sites are missing E/I data?
nrow(nla_id) - nrow(evap_infl)

# Note that most of the missing data comes from the site revisits
missing_check <- nla_all_coms %>%
  left_join(evap_infl, by = c("UNIQUE_ID","DSGN_CYCLE","VISIT_NO")) %>%
  filter(is.na(RESULT))

table(missing_check$VISIT_NO)

```


Add watershed metrics compiled by Marc Weber for all NLA lakes (in Lakecat and not in Lakecat)

```{r}
# Watershed metrics for NLA lakes compiled by Marc
wsmet <- read.csv("NLA_WatershedMetrics_NoDuplicates.csv")

# Select data I want to use and join with NLA data
wsmet <- wsmet %>%
  select(UNIQUE_ID, DSGN_CYCLE, lakemorpho_depth, RunoffWs, Precip_Minus_EVTWs, WWTPWs, starts_with("Pct"), Precip8110Ws, Tmean8110Ws, ElevWs, SlopeWs) %>%
  right_join(nla_id, by = c("UNIQUE_ID", "DSGN_CYCLE"))


```

Compile together NLA, NLA+, and LakeCat data

```{r}

habs <- nla_long %>%
  bind_rows(evap_infl) %>%
  select(!UNITS) %>%
  pivot_wider(names_from = ANALYTE, values_from = RESULT, values_fill = -99) %>%
  left_join(wsmet, by = c("UNIQUE_ID", "DSGN_CYCLE"))

# Create data for the package
# usethis::use_data(habs)

```
